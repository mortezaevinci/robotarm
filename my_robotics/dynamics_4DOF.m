%get the info from lagrange_solver_4DOF copy-pasted
dynamics_4DOF_init

%states
th1_=sym('th1_','real');th2_=sym('th2_','real');th3_=sym('th3_','real');th4_=sym('th4_','real');

%states dot
thdot1_=sym('thdot1_','real');thdot2_=sym('thdot2_','real');thdot3_=sym('thdot3_','real');thdot4_=sym('thdot4_','real');

%states dot dot
thdotdot1_=sym('thdotdot1_','real');thdotdot2_=sym('thdotdot2_','real');thdotdot3_=sym('thdotdot3_','real');thdotdot4_=sym('thdotdot4_','real');


dyn_ =[
 
 Iyy1*thdotdot1_ + Iyy2*thdotdot1_ + Iyy2*thdotdot2_ + 1/2*m1*(2*(1/2*l1*thdot4_*sin(th1_)*sin(th4_) - 1/2*l1*thdot1_*cos(th1_)*cos(th4_))*(1/2*l1*thdot1_*cos(th4_)*sin(th1_) + 1/2*l1*thdot4_*cos(th1_)*sin(th4_)) - 2*(1/2*l1*thdot1_*sin(th1_)*sin(th4_) - 1/2*l1*thdot4_*cos(th1_)*cos(th4_))*(1/2*l1*thdot1_*cos(th1_)*sin(th4_) + 1/2*l1*thdot4_*cos(th4_)*sin(th1_)) + 1/2*l1^2*thdot1_^2*cos(th1_)*sin(th1_)) + c1*thdot1_ + 1/2*m2*(2*(1/2*l2*cos(th1_ + th2_) + l1*cos(th1_))*(l1*thdotdot1_*cos(th1_) - 1/2*l2*sin(th1_ + th2_)*(thdot1_ + thdot2_)^2 - l1*thdot1_^2*sin(th1_) + 1/2*l2*cos(th1_ + th2_)*(thdotdot1_ + thdotdot2_)) - 2*(l1*thdot1_*cos(th1_) + 1/2*l2*cos(th1_ + th2_)*(thdot1_ + thdot2_))*(l1*thdot1_*sin(th1_) + 1/2*l2*sin(th1_ + th2_)*(thdot1_ + thdot2_)) + 2*cos(th4_)*(1/2*l2*sin(th1_ + th2_) + l1*sin(th1_))*(cos(th4_)*(1/2*l2*cos(th1_ + th2_) + l1*cos(th1_))*thdot4_^2 - 2*sin(th4_)*(l1*thdot1_*sin(th1_) + 1/2*l2*sin(th1_ + th2_)*(thdot1_ + thdot2_))*thdot4_ + cos(th4_)*(1/2*l2*cos(th1_ + th2_)*(thdot1_ + thdot2_)^2 + l1*thdotdot1_*sin(th1_) + l1*thdot1_^2*cos(th1_) + 1/2*l2*sin(th1_ + th2_)*(thdotdot1_ + thdotdot2_)) + thdotdot4_*sin(th4_)*(1/2*l2*cos(th1_ + th2_) + l1*cos(th1_))) + 2*sin(th4_)*(1/2*l2*sin(th1_ + th2_) + l1*sin(th1_))*(sin(th4_)*(1/2*l2*cos(th1_ + th2_) + l1*cos(th1_))*thdot4_^2 + 2*cos(th4_)*(l1*thdot1_*sin(th1_) + 1/2*l2*sin(th1_ + th2_)*(thdot1_ + thdot2_))*thdot4_ + sin(th4_)*(1/2*l2*cos(th1_ + th2_)*(thdot1_ + thdot2_)^2 + l1*thdotdot1_*sin(th1_) + l1*thdot1_^2*cos(th1_) + 1/2*l2*sin(th1_ + th2_)*(thdotdot1_ + thdotdot2_)) - thdotdot4_*cos(th4_)*(1/2*l2*cos(th1_ + th2_) + l1*cos(th1_))) + 2*cos(th4_)*(cos(th4_)*(l1*thdot1_*sin(th1_) + 1/2*l2*sin(th1_ + th2_)*(thdot1_ + thdot2_)) + thdot4_*sin(th4_)*(1/2*l2*cos(th1_ + th2_) + l1*cos(th1_)))*(l1*thdot1_*cos(th1_) + 1/2*l2*cos(th1_ + th2_)*(thdot1_ + thdot2_)) + 2*sin(th4_)*(sin(th4_)*(l1*thdot1_*sin(th1_) + 1/2*l2*sin(th1_ + th2_)*(thdot1_ + thdot2_)) - thdot4_*cos(th4_)*(1/2*l2*cos(th1_ + th2_) + l1*cos(th1_)))*(l1*thdot1_*cos(th1_) + 1/2*l2*cos(th1_ + th2_)*(thdot1_ + thdot2_)) + 2*thdot4_*cos(th4_)*(sin(th4_)*(l1*thdot1_*sin(th1_) + 1/2*l2*sin(th1_ + th2_)*(thdot1_ + thdot2_)) - thdot4_*cos(th4_)*(1/2*l2*cos(th1_ + th2_) + l1*cos(th1_)))*(1/2*l2*sin(th1_ + th2_) + l1*sin(th1_)) - 2*thdot4_*sin(th4_)*(cos(th4_)*(l1*thdot1_*sin(th1_) + 1/2*l2*sin(th1_ + th2_)*(thdot1_ + thdot2_)) + thdot4_*sin(th4_)*(1/2*l2*cos(th1_ + th2_) + l1*cos(th1_)))*(1/2*l2*sin(th1_ + th2_) + l1*sin(th1_))) - 1/2*m3*(2*(sin(th4_)*(l1*thdot1_*cos(th1_) + 1/2*l3*cos(th1_ + th2_ + th3_)*(thdot1_ + thdot2_ + thdot3_) + l2*cos(th1_ + th2_)*(thdot1_ + thdot2_)) + thdot4_*cos(th4_)*(l2*sin(th1_ + th2_) + l1*sin(th1_) + 1/2*l3*sin(th1_ + th2_ + th3_)))*(sin(th4_)*(l1*thdot1_*sin(th1_) + 1/2*l3*sin(th1_ + th2_ + th3_)*(thdot1_ + thdot2_ + thdot3_) + l2*sin(th1_ + th2_)*(thdot1_ + thdot2_)) - thdot4_*cos(th4_)*(l2*cos(th1_ + th2_) + l1*cos(th1_) + 1/2*l3*cos(th1_ + th2_ + th3_))) - 2*(l1*thdot1_*sin(th1_) + 1/2*l3*sin(th1_ + th2_ + th3_)*(thdot1_ + thdot2_ + thdot3_) + l2*sin(th1_ + th2_)*(thdot1_ + thdot2_))*(l1*thdot1_*cos(th1_) + 1/2*l3*cos(th1_ + th2_ + th3_)*(thdot1_ + thdot2_ + thdot3_) + l2*cos(th1_ + th2_)*(thdot1_ + thdot2_)) + 2*(cos(th4_)*(l1*thdot1_*sin(th1_) + 1/2*l3*sin(th1_ + th2_ + th3_)*(thdot1_ + thdot2_ + thdot3_) + l2*sin(th1_ + th2_)*(thdot1_ + thdot2_)) + thdot4_*sin(th4_)*(l2*cos(th1_ + th2_) + l1*cos(th1_) + 1/2*l3*cos(th1_ + th2_ + th3_)))*(cos(th4_)*(l1*thdot1_*cos(th1_) + 1/2*l3*cos(th1_ + th2_ + th3_)*(thdot1_ + thdot2_ + thdot3_) + l2*cos(th1_ + th2_)*(thdot1_ + thdot2_)) - thdot4_*sin(th4_)*(l2*sin(th1_ + th2_) + l1*sin(th1_) + 1/2*l3*sin(th1_ + th2_ + th3_)))) + 1/2*Iyy3*(thdotdot1_ + thdotdot2_ + thdotdot3_) - 1/2*m2*(2*(sin(th4_)*(l1*thdot1_*cos(th1_) + 1/2*l2*cos(th1_ + th2_)*(thdot1_ + thdot2_)) + thdot4_*cos(th4_)*(1/2*l2*sin(th1_ + th2_) + l1*sin(th1_)))*(sin(th4_)*(l1*thdot1_*sin(th1_) + 1/2*l2*sin(th1_ + th2_)*(thdot1_ + thdot2_)) - thdot4_*cos(th4_)*(1/2*l2*cos(th1_ + th2_) + l1*cos(th1_))) + 2*(cos(th4_)*(l1*thdot1_*sin(th1_) + 1/2*l2*sin(th1_ + th2_)*(thdot1_ + thdot2_)) + thdot4_*sin(th4_)*(1/2*l2*cos(th1_ + th2_) + l1*cos(th1_)))*(cos(th4_)*(l1*thdot1_*cos(th1_) + 1/2*l2*cos(th1_ + th2_)*(thdot1_ + thdot2_)) - thdot4_*sin(th4_)*(1/2*l2*sin(th1_ + th2_) + l1*sin(th1_))) - 2*(l1*thdot1_*cos(th1_) + 1/2*l2*cos(th1_ + th2_)*(thdot1_ + thdot2_))*(l1*thdot1_*sin(th1_) + 1/2*l2*sin(th1_ + th2_)*(thdot1_ + thdot2_))) + Iyy3*(1/2*thdotdot1_ + 1/2*thdotdot2_ + 1/2*thdotdot3_) + 1/2*m3*(2*cos(th4_)*(l2*sin(th1_ + th2_) + l1*sin(th1_) + 1/2*l3*sin(th1_ + th2_ + th3_))*(cos(th4_)*(l2*cos(th1_ + th2_) + l1*cos(th1_) + 1/2*l3*cos(th1_ + th2_ + th3_))*thdot4_^2 - 2*sin(th4_)*(l1*thdot1_*sin(th1_) + 1/2*l3*sin(th1_ + th2_ + th3_)*(thdot1_ + thdot2_ + thdot3_) + l2*sin(th1_ + th2_)*(thdot1_ + thdot2_))*thdot4_ + cos(th4_)*(1/2*l3*cos(th1_ + th2_ + th3_)*(thdot1_ + thdot2_ + thdot3_)^2 + l2*cos(th1_ + th2_)*(thdot1_ + thdot2_)^2 + l1*thdotdot1_*sin(th1_) + l1*thdot1_^2*cos(th1_) + 1/2*l3*sin(th1_ + th2_ + th3_)*(thdotdot1_ + thdotdot2_ + thdotdot3_) + l2*sin(th1_ + th2_)*(thdotdot1_ + thdotdot2_)) + thdotdot4_*sin(th4_)*(l2*cos(th1_ + th2_) + l1*cos(th1_) + 1/2*l3*cos(th1_ + th2_ + th3_))) - 2*(l2*cos(th1_ + th2_) + l1*cos(th1_) + 1/2*l3*cos(th1_ + th2_ + th3_))*(1/2*l3*sin(th1_ + th2_ + th3_)*(thdot1_ + thdot2_ + thdot3_)^2 - l1*thdotdot1_*cos(th1_) + l2*sin(th1_ + th2_)*(thdot1_ + thdot2_)^2 + l1*thdot1_^2*sin(th1_) - 1/2*l3*cos(th1_ + th2_ + th3_)*(thdotdot1_ + thdotdot2_ + thdotdot3_) - l2*cos(th1_ + th2_)*(thdotdot1_ + thdotdot2_)) - 2*(l1*thdot1_*sin(th1_) + 1/2*l3*sin(th1_ + th2_ + th3_)*(thdot1_ + thdot2_ + thdot3_) + l2*sin(th1_ + th2_)*(thdot1_ + thdot2_))*(l1*thdot1_*cos(th1_) + 1/2*l3*cos(th1_ + th2_ + th3_)*(thdot1_ + thdot2_ + thdot3_) + l2*cos(th1_ + th2_)*(thdot1_ + thdot2_)) + 2*sin(th4_)*(l2*sin(th1_ + th2_) + l1*sin(th1_) + 1/2*l3*sin(th1_ + th2_ + th3_))*(sin(th4_)*(l2*cos(th1_ + th2_) + l1*cos(th1_) + 1/2*l3*cos(th1_ + th2_ + th3_))*thdot4_^2 + 2*cos(th4_)*(l1*thdot1_*sin(th1_) + 1/2*l3*sin(th1_ + th2_ + th3_)*(thdot1_ + thdot2_ + thdot3_) + l2*sin(th1_ + th2_)*(thdot1_ + thdot2_))*thdot4_ + sin(th4_)*(1/2*l3*cos(th1_ + th2_ + th3_)*(thdot1_ + thdot2_ + thdot3_)^2 + l2*cos(th1_ + th2_)*(thdot1_ + thdot2_)^2 + l1*thdotdot1_*sin(th1_) + l1*thdot1_^2*cos(th1_) + 1/2*l3*sin(th1_ + th2_ + th3_)*(thdotdot1_ + thdotdot2_ + thdotdot3_) + l2*sin(th1_ + th2_)*(thdotdot1_ + thdotdot2_)) - thdotdot4_*cos(th4_)*(l2*cos(th1_ + th2_) + l1*cos(th1_) + 1/2*l3*cos(th1_ + th2_ + th3_))) + 2*cos(th4_)*(cos(th4_)*(l1*thdot1_*sin(th1_) + 1/2*l3*sin(th1_ + th2_ + th3_)*(thdot1_ + thdot2_ + thdot3_) + l2*sin(th1_ + th2_)*(thdot1_ + thdot2_)) + thdot4_*sin(th4_)*(l2*cos(th1_ + th2_) + l1*cos(th1_) + 1/2*l3*cos(th1_ + th2_ + th3_)))*(l1*thdot1_*cos(th1_) + 1/2*l3*cos(th1_ + th2_ + th3_)*(thdot1_ + thdot2_ + thdot3_) + l2*cos(th1_ + th2_)*(thdot1_ + thdot2_)) + 2*sin(th4_)*(sin(th4_)*(l1*thdot1_*sin(th1_) + 1/2*l3*sin(th1_ + th2_ + th3_)*(thdot1_ + thdot2_ + thdot3_) + l2*sin(th1_ + th2_)*(thdot1_ + thdot2_)) - thdot4_*cos(th4_)*(l2*cos(th1_ + th2_) + l1*cos(th1_) + 1/2*l3*cos(th1_ + th2_ + th3_)))*(l1*thdot1_*cos(th1_) + 1/2*l3*cos(th1_ + th2_ + th3_)*(thdot1_ + thdot2_ + thdot3_) + l2*cos(th1_ + th2_)*(thdot1_ + thdot2_)) + 2*thdot4_*cos(th4_)*(sin(th4_)*(l1*thdot1_*sin(th1_) + 1/2*l3*sin(th1_ + th2_ + th3_)*(thdot1_ + thdot2_ + thdot3_) + l2*sin(th1_ + th2_)*(thdot1_ + thdot2_)) - thdot4_*cos(th4_)*(l2*cos(th1_ + th2_) + l1*cos(th1_) + 1/2*l3*cos(th1_ + th2_ + th3_)))*(l2*sin(th1_ + th2_) + l1*sin(th1_) + 1/2*l3*sin(th1_ + th2_ + th3_)) - 2*thdot4_*sin(th4_)*(cos(th4_)*(l1*thdot1_*sin(th1_) + 1/2*l3*sin(th1_ + th2_ + th3_)*(thdot1_ + thdot2_ + thdot3_) + l2*sin(th1_ + th2_)*(thdot1_ + thdot2_)) + thdot4_*sin(th4_)*(l2*cos(th1_ + th2_) + l1*cos(th1_) + 1/2*l3*cos(th1_ + th2_ + th3_)))*(l2*sin(th1_ + th2_) + l1*sin(th1_) + 1/2*l3*sin(th1_ + th2_ + th3_))) + 1/4*l1^2*m1*thdotdot1_ + g*m4*(l2*cos(th1_ + th2_) + l1*cos(th1_) + 1/2*l3*cos(th1_ + th2_ + th3_)) + g*m3*(1/2*l2*cos(th1_ + th2_) + l1*cos(th1_)) + Ixx1*thdot4_^2*cos(th1_)*sin(th1_) - Izz1*thdot4_^2*cos(th1_)*sin(th1_) + 1/2*g*l1*m2*cos(th1_) + Ixx3*thdot4_^2*cos(th1_ + th2_ + th3_)*sin(th1_ + th2_ + th3_) - Izz3*thdot4_^2*cos(th1_ + th2_ + th3_)*sin(th1_ + th2_ + th3_) + Ixx2*thdot4_^2*cos(th1_ + th2_)*sin(th1_ + th2_) - Izz2*thdot4_^2*cos(th1_ + th2_)*sin(th1_ + th2_);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               Iyy2*thdotdot1_ + Iyy2*thdotdot2_ + Iyy3*thdotdot1_ + Iyy3*thdotdot2_ + Iyy3*thdotdot3_ + c2*thdot2_ - 1/2*m3*(2*(cos(th4_)*(l1*thdot1_*sin(th1_) + 1/2*l3*sin(th1_ + th2_ + th3_)*(thdot1_ + thdot2_ + thdot3_) + l2*sin(th1_ + th2_)*(thdot1_ + thdot2_)) + thdot4_*sin(th4_)*(l2*cos(th1_ + th2_) + l1*cos(th1_) + 1/2*l3*cos(th1_ + th2_ + th3_)))*(cos(th4_)*(1/2*l3*cos(th1_ + th2_ + th3_)*(thdot1_ + thdot2_ + thdot3_) + l2*cos(th1_ + th2_)*(thdot1_ + thdot2_)) - thdot4_*sin(th4_)*(l2*sin(th1_ + th2_) + 1/2*l3*sin(th1_ + th2_ + th3_))) + 2*(sin(th4_)*(l1*thdot1_*sin(th1_) + 1/2*l3*sin(th1_ + th2_ + th3_)*(thdot1_ + thdot2_ + thdot3_) + l2*sin(th1_ + th2_)*(thdot1_ + thdot2_)) - thdot4_*cos(th4_)*(l2*cos(th1_ + th2_) + l1*cos(th1_) + 1/2*l3*cos(th1_ + th2_ + th3_)))*(sin(th4_)*(1/2*l3*cos(th1_ + th2_ + th3_)*(thdot1_ + thdot2_ + thdot3_) + l2*cos(th1_ + th2_)*(thdot1_ + thdot2_)) + thdot4_*cos(th4_)*(l2*sin(th1_ + th2_) + 1/2*l3*sin(th1_ + th2_ + th3_))) - 2*(1/2*l3*sin(th1_ + th2_ + th3_)*(thdot1_ + thdot2_ + thdot3_) + l2*sin(th1_ + th2_)*(thdot1_ + thdot2_))*(l1*thdot1_*cos(th1_) + 1/2*l3*cos(th1_ + th2_ + th3_)*(thdot1_ + thdot2_ + thdot3_) + l2*cos(th1_ + th2_)*(thdot1_ + thdot2_))) - 1/2*m2*(2*(cos(th4_)*(l1*thdot1_*sin(th1_) + 1/2*l2*sin(th1_ + th2_)*(thdot1_ + thdot2_)) + thdot4_*sin(th4_)*(1/2*l2*cos(th1_ + th2_) + l1*cos(th1_)))*(1/2*l2*cos(th1_ + th2_)*cos(th4_)*(thdot1_ + thdot2_) - 1/2*l2*thdot4_*sin(th1_ + th2_)*sin(th4_)) + 2*(sin(th4_)*(l1*thdot1_*sin(th1_) + 1/2*l2*sin(th1_ + th2_)*(thdot1_ + thdot2_)) - thdot4_*cos(th4_)*(1/2*l2*cos(th1_ + th2_) + l1*cos(th1_)))*(1/2*l2*cos(th1_ + th2_)*sin(th4_)*(thdot1_ + thdot2_) + 1/2*l2*thdot4_*sin(th1_ + th2_)*cos(th4_)) - l2*sin(th1_ + th2_)*(l1*thdot1_*cos(th1_) + 1/2*l2*cos(th1_ + th2_)*(thdot1_ + thdot2_))*(thdot1_ + thdot2_)) + 1/4*l2^2*m2*thdotdot1_ + 1/4*l2^2*m2*thdotdot2_ + l2^2*m3*thdotdot1_ + l2^2*m3*thdotdot2_ + 1/4*l3^2*m3*thdotdot1_ + 1/4*l3^2*m3*thdotdot2_ + 1/4*l3^2*m3*thdotdot3_ + g*m4*(l2*cos(th1_ + th2_) + 1/2*l3*cos(th1_ + th2_ + th3_)) + 1/2*g*l2*m3*cos(th1_ + th2_) + Ixx3*thdot4_^2*cos(th1_ + th2_ + th3_)*sin(th1_ + th2_ + th3_) - Izz3*thdot4_^2*cos(th1_ + th2_ + th3_)*sin(th1_ + th2_ + th3_) + Ixx2*thdot4_^2*cos(th1_ + th2_)*sin(th1_ + th2_) - Izz2*thdot4_^2*cos(th1_ + th2_)*sin(th1_ + th2_) - 1/2*l2*l3*m3*thdot3_^2*sin(th3_) + 1/2*l1*l3*m3*thdotdot1_*cos(th2_ + th3_) + 1/2*l1*l2*m2*thdotdot1_*cos(th2_) + l1*l2*m3*thdotdot1_*cos(th2_) + l2*l3*m3*thdotdot1_*cos(th3_) + l2*l3*m3*thdotdot2_*cos(th3_) + 1/2*l2*l3*m3*thdotdot3_*cos(th3_) - 1/2*l1*l3*m3*thdot1_*thdot2_*sin(th2_ + th3_) - 1/2*l1*l3*m3*thdot1_*thdot3_*sin(th2_ + th3_) - 1/2*l1*l2*m2*thdot1_*thdot2_*sin(th2_) - l1*l2*m3*thdot1_*thdot2_*sin(th2_) - l2*l3*m3*thdot1_*thdot3_*sin(th3_) - l2*l3*m3*thdot2_*thdot3_*sin(th3_);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   Iyy3*thdotdot1_ + Iyy3*thdotdot2_ + Iyy3*thdotdot3_ + c3*thdot3_ + 1/2*m3*(2*(1/2*l3*thdot4_*sin(th1_ + th2_ + th3_)*sin(th4_) - 1/2*l3*cos(th1_ + th2_ + th3_)*cos(th4_)*(thdot1_ + thdot2_ + thdot3_))*(cos(th4_)*(l1*thdot1_*sin(th1_) + 1/2*l3*sin(th1_ + th2_ + th3_)*(thdot1_ + thdot2_ + thdot3_) + l2*sin(th1_ + th2_)*(thdot1_ + thdot2_)) + thdot4_*sin(th4_)*(l2*cos(th1_ + th2_) + l1*cos(th1_) + 1/2*l3*cos(th1_ + th2_ + th3_))) - 2*(1/2*l3*thdot4_*sin(th1_ + th2_ + th3_)*cos(th4_) + 1/2*l3*cos(th1_ + th2_ + th3_)*sin(th4_)*(thdot1_ + thdot2_ + thdot3_))*(sin(th4_)*(l1*thdot1_*sin(th1_) + 1/2*l3*sin(th1_ + th2_ + th3_)*(thdot1_ + thdot2_ + thdot3_) + l2*sin(th1_ + th2_)*(thdot1_ + thdot2_)) - thdot4_*cos(th4_)*(l2*cos(th1_ + th2_) + l1*cos(th1_) + 1/2*l3*cos(th1_ + th2_ + th3_))) + l3*sin(th1_ + th2_ + th3_)*(thdot1_ + thdot2_ + thdot3_)*(l1*thdot1_*cos(th1_) + 1/2*l3*cos(th1_ + th2_ + th3_)*(thdot1_ + thdot2_ + thdot3_) + l2*cos(th1_ + th2_)*(thdot1_ + thdot2_))) + 1/4*l3^2*m3*thdotdot1_ + 1/4*l3^2*m3*thdotdot2_ + 1/4*l3^2*m3*thdotdot3_ + 1/2*g*l3*m4*cos(th1_ + th2_ + th3_) + Ixx3*thdot4_^2*cos(th1_ + th2_ + th3_)*sin(th1_ + th2_ + th3_) - Izz3*thdot4_^2*cos(th1_ + th2_ + th3_)*sin(th1_ + th2_ + th3_) + 1/2*l1*l3*m3*thdotdot1_*cos(th2_ + th3_) + 1/2*l2*l3*m3*thdotdot1_*cos(th3_) + 1/2*l2*l3*m3*thdotdot2_*cos(th3_) - 1/2*l1*l3*m3*thdot1_*thdot2_*sin(th2_ + th3_) - 1/2*l1*l3*m3*thdot1_*thdot3_*sin(th2_ + th3_) - 1/2*l2*l3*m3*thdot1_*thdot3_*sin(th3_) - 1/2*l2*l3*m3*thdot2_*thdot3_*sin(th3_);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             I4*thdotdot4_ + c4*thdot4_ + 1/2*m2*(2*sin(th4_)*(1/2*l2*cos(th1_ + th2_) + l1*cos(th1_))*(cos(th4_)*(1/2*l2*cos(th1_ + th2_) + l1*cos(th1_))*thdot4_^2 - 2*sin(th4_)*(l1*thdot1_*sin(th1_) + 1/2*l2*sin(th1_ + th2_)*(thdot1_ + thdot2_))*thdot4_ + cos(th4_)*(1/2*l2*cos(th1_ + th2_)*(thdot1_ + thdot2_)^2 + l1*thdotdot1_*sin(th1_) + l1*thdot1_^2*cos(th1_) + 1/2*l2*sin(th1_ + th2_)*(thdotdot1_ + thdotdot2_)) + thdotdot4_*sin(th4_)*(1/2*l2*cos(th1_ + th2_) + l1*cos(th1_))) - 2*cos(th4_)*(1/2*l2*cos(th1_ + th2_) + l1*cos(th1_))*(sin(th4_)*(1/2*l2*cos(th1_ + th2_) + l1*cos(th1_))*thdot4_^2 + 2*cos(th4_)*(l1*thdot1_*sin(th1_) + 1/2*l2*sin(th1_ + th2_)*(thdot1_ + thdot2_))*thdot4_ + sin(th4_)*(1/2*l2*cos(th1_ + th2_)*(thdot1_ + thdot2_)^2 + l1*thdotdot1_*sin(th1_) + l1*thdot1_^2*cos(th1_) + 1/2*l2*sin(th1_ + th2_)*(thdotdot1_ + thdotdot2_)) - thdotdot4_*cos(th4_)*(1/2*l2*cos(th1_ + th2_) + l1*cos(th1_))) + 2*cos(th4_)*(sin(th4_)*(l1*thdot1_*sin(th1_) + 1/2*l2*sin(th1_ + th2_)*(thdot1_ + thdot2_)) - thdot4_*cos(th4_)*(1/2*l2*cos(th1_ + th2_) + l1*cos(th1_)))*(l1*thdot1_*sin(th1_) + 1/2*l2*sin(th1_ + th2_)*(thdot1_ + thdot2_)) - 2*sin(th4_)*(cos(th4_)*(l1*thdot1_*sin(th1_) + 1/2*l2*sin(th1_ + th2_)*(thdot1_ + thdot2_)) + thdot4_*sin(th4_)*(1/2*l2*cos(th1_ + th2_) + l1*cos(th1_)))*(l1*thdot1_*sin(th1_) + 1/2*l2*sin(th1_ + th2_)*(thdot1_ + thdot2_)) + 2*thdot4_*cos(th4_)*(cos(th4_)*(l1*thdot1_*sin(th1_) + 1/2*l2*sin(th1_ + th2_)*(thdot1_ + thdot2_)) + thdot4_*sin(th4_)*(1/2*l2*cos(th1_ + th2_) + l1*cos(th1_)))*(1/2*l2*cos(th1_ + th2_) + l1*cos(th1_)) + 2*thdot4_*sin(th4_)*(sin(th4_)*(l1*thdot1_*sin(th1_) + 1/2*l2*sin(th1_ + th2_)*(thdot1_ + thdot2_)) - thdot4_*cos(th4_)*(1/2*l2*cos(th1_ + th2_) + l1*cos(th1_)))*(1/2*l2*cos(th1_ + th2_) + l1*cos(th1_))) + 1/2*m3*(2*cos(th4_)*(sin(th4_)*(l1*thdot1_*sin(th1_) + 1/2*l3*sin(th1_ + th2_ + th3_)*(thdot1_ + thdot2_ + thdot3_) + l2*sin(th1_ + th2_)*(thdot1_ + thdot2_)) - thdot4_*cos(th4_)*(l2*cos(th1_ + th2_) + l1*cos(th1_) + 1/2*l3*cos(th1_ + th2_ + th3_)))*(l1*thdot1_*sin(th1_) + 1/2*l3*sin(th1_ + th2_ + th3_)*(thdot1_ + thdot2_ + thdot3_) + l2*sin(th1_ + th2_)*(thdot1_ + thdot2_)) - 2*sin(th4_)*(cos(th4_)*(l1*thdot1_*sin(th1_) + 1/2*l3*sin(th1_ + th2_ + th3_)*(thdot1_ + thdot2_ + thdot3_) + l2*sin(th1_ + th2_)*(thdot1_ + thdot2_)) + thdot4_*sin(th4_)*(l2*cos(th1_ + th2_) + l1*cos(th1_) + 1/2*l3*cos(th1_ + th2_ + th3_)))*(l1*thdot1_*sin(th1_) + 1/2*l3*sin(th1_ + th2_ + th3_)*(thdot1_ + thdot2_ + thdot3_) + l2*sin(th1_ + th2_)*(thdot1_ + thdot2_)) - 2*cos(th4_)*(l2*cos(th1_ + th2_) + l1*cos(th1_) + 1/2*l3*cos(th1_ + th2_ + th3_))*(sin(th4_)*(l2*cos(th1_ + th2_) + l1*cos(th1_) + 1/2*l3*cos(th1_ + th2_ + th3_))*thdot4_^2 + 2*cos(th4_)*(l1*thdot1_*sin(th1_) + 1/2*l3*sin(th1_ + th2_ + th3_)*(thdot1_ + thdot2_ + thdot3_) + l2*sin(th1_ + th2_)*(thdot1_ + thdot2_))*thdot4_ + sin(th4_)*(1/2*l3*cos(th1_ + th2_ + th3_)*(thdot1_ + thdot2_ + thdot3_)^2 + l2*cos(th1_ + th2_)*(thdot1_ + thdot2_)^2 + l1*thdotdot1_*sin(th1_) + l1*thdot1_^2*cos(th1_) + 1/2*l3*sin(th1_ + th2_ + th3_)*(thdotdot1_ + thdotdot2_ + thdotdot3_) + l2*sin(th1_ + th2_)*(thdotdot1_ + thdotdot2_)) - thdotdot4_*cos(th4_)*(l2*cos(th1_ + th2_) + l1*cos(th1_) + 1/2*l3*cos(th1_ + th2_ + th3_))) + 2*sin(th4_)*(l2*cos(th1_ + th2_) + l1*cos(th1_) + 1/2*l3*cos(th1_ + th2_ + th3_))*(cos(th4_)*(l2*cos(th1_ + th2_) + l1*cos(th1_) + 1/2*l3*cos(th1_ + th2_ + th3_))*thdot4_^2 - 2*sin(th4_)*(l1*thdot1_*sin(th1_) + 1/2*l3*sin(th1_ + th2_ + th3_)*(thdot1_ + thdot2_ + thdot3_) + l2*sin(th1_ + th2_)*(thdot1_ + thdot2_))*thdot4_ + cos(th4_)*(1/2*l3*cos(th1_ + th2_ + th3_)*(thdot1_ + thdot2_ + thdot3_)^2 + l2*cos(th1_ + th2_)*(thdot1_ + thdot2_)^2 + l1*thdotdot1_*sin(th1_) + l1*thdot1_^2*cos(th1_) + 1/2*l3*sin(th1_ + th2_ + th3_)*(thdotdot1_ + thdotdot2_ + thdotdot3_) + l2*sin(th1_ + th2_)*(thdotdot1_ + thdotdot2_)) + thdotdot4_*sin(th4_)*(l2*cos(th1_ + th2_) + l1*cos(th1_) + 1/2*l3*cos(th1_ + th2_ + th3_))) + 2*thdot4_*cos(th4_)*(cos(th4_)*(l1*thdot1_*sin(th1_) + 1/2*l3*sin(th1_ + th2_ + th3_)*(thdot1_ + thdot2_ + thdot3_) + l2*sin(th1_ + th2_)*(thdot1_ + thdot2_)) + thdot4_*sin(th4_)*(l2*cos(th1_ + th2_) + l1*cos(th1_) + 1/2*l3*cos(th1_ + th2_ + th3_)))*(l2*cos(th1_ + th2_) + l1*cos(th1_) + 1/2*l3*cos(th1_ + th2_ + th3_)) + 2*thdot4_*sin(th4_)*(sin(th4_)*(l1*thdot1_*sin(th1_) + 1/2*l3*sin(th1_ + th2_ + th3_)*(thdot1_ + thdot2_ + thdot3_) + l2*sin(th1_ + th2_)*(thdot1_ + thdot2_)) - thdot4_*cos(th4_)*(l2*cos(th1_ + th2_) + l1*cos(th1_) + 1/2*l3*cos(th1_ + th2_ + th3_)))*(l2*cos(th1_ + th2_) + l1*cos(th1_) + 1/2*l3*cos(th1_ + th2_ + th3_))) + Ixx2*thdotdot4_*cos(th1_ + th2_)^2 + Ixx1*thdotdot4_*cos(th1_)^2 - Izz2*thdotdot4_*(cos(th1_ + th2_)^2 - 1) + Ixx3*thdotdot4_*cos(th1_ + th2_ + th3_)^2 - Izz1*thdotdot4_*(cos(th1_)^2 - 1) - Izz3*thdotdot4_*(cos(th1_ + th2_ + th3_)^2 - 1) - 2*Ixx3*thdot4_*cos(th1_ + th2_ + th3_)*sin(th1_ + th2_ + th3_)*(thdot1_ + thdot2_ + thdot3_) + 2*Izz3*thdot4_*cos(th1_ + th2_ + th3_)*sin(th1_ + th2_ + th3_)*(thdot1_ + thdot2_ + thdot3_) - 2*Ixx1*thdot1_*thdot4_*cos(th1_)*sin(th1_) + 2*Izz1*thdot1_*thdot4_*cos(th1_)*sin(th1_) + 1/4*l1^2*m1*thdotdot4_*cos(th1_)^2*cos(th4_)^2 + 1/4*l1^2*m1*thdotdot4_*cos(th1_)^2*sin(th4_)^2 - 2*Ixx2*thdot4_*cos(th1_ + th2_)*sin(th1_ + th2_)*(thdot1_ + thdot2_) + 2*Izz2*thdot4_*cos(th1_ + th2_)*sin(th1_ + th2_)*(thdot1_ + thdot2_) - 1/2*l1^2*m1*thdot1_*thdot4_*cos(th1_)*cos(th4_)^2*sin(th1_) - 1/2*l1^2*m1*thdot1_*thdot4_*cos(th1_)*sin(th1_)*sin(th4_)^2;
 
]
G =[
 
 g*m4*(l2*cos(th1_ + th2_) + l1*cos(th1_) + 1/2*l3*cos(th1_ + th2_ + th3_)) + g*m3*(1/2*l2*cos(th1_ + th2_) + l1*cos(th1_)) + 1/2*g*l1*m2*cos(th1_);
                                                         g*m4*(l2*cos(th1_ + th2_) + 1/2*l3*cos(th1_ + th2_ + th3_)) + 1/2*g*l2*m3*cos(th1_ + th2_);
                                                                                                                1/2*g*l3*m4*cos(th1_ + th2_ + th3_);
                                                                                                                                                  0;
 
 ]
V =[
 
 1/2*m1*(2*(1/2*l1*thdot4_*sin(th1_)*sin(th4_) - 1/2*l1*thdot1_*cos(th1_)*cos(th4_))*(1/2*l1*thdot1_*cos(th4_)*sin(th1_) + 1/2*l1*thdot4_*cos(th1_)*sin(th4_)) - 2*(1/2*l1*thdot1_*sin(th1_)*sin(th4_) - 1/2*l1*thdot4_*cos(th1_)*cos(th4_))*(1/2*l1*thdot1_*cos(th1_)*sin(th4_) + 1/2*l1*thdot4_*cos(th4_)*sin(th1_)) + 1/2*l1^2*thdot1_^2*cos(th1_)*sin(th1_)) + 1/2*m2*(2*sin(th4_)*(1/2*l2*sin(th1_ + th2_) + l1*sin(th1_))*(sin(th4_)*(1/2*l2*cos(th1_ + th2_) + l1*cos(th1_))*thdot4_^2 + 2*cos(th4_)*(l1*thdot1_*sin(th1_) + 1/2*l2*sin(th1_ + th2_)*(thdot1_ + thdot2_))*thdot4_ + sin(th4_)*(1/2*l2*cos(th1_ + th2_)*(thdot1_ + thdot2_)^2 + l1*thdot1_^2*cos(th1_))) - 2*(1/2*l2*sin(th1_ + th2_)*(thdot1_ + thdot2_)^2 + l1*thdot1_^2*sin(th1_))*(1/2*l2*cos(th1_ + th2_) + l1*cos(th1_)) - 2*(l1*thdot1_*cos(th1_) + 1/2*l2*cos(th1_ + th2_)*(thdot1_ + thdot2_))*(l1*thdot1_*sin(th1_) + 1/2*l2*sin(th1_ + th2_)*(thdot1_ + thdot2_)) + 2*cos(th4_)*(cos(th4_)*(l1*thdot1_*sin(th1_) + 1/2*l2*sin(th1_ + th2_)*(thdot1_ + thdot2_)) + thdot4_*sin(th4_)*(1/2*l2*cos(th1_ + th2_) + l1*cos(th1_)))*(l1*thdot1_*cos(th1_) + 1/2*l2*cos(th1_ + th2_)*(thdot1_ + thdot2_)) + 2*sin(th4_)*(sin(th4_)*(l1*thdot1_*sin(th1_) + 1/2*l2*sin(th1_ + th2_)*(thdot1_ + thdot2_)) - thdot4_*cos(th4_)*(1/2*l2*cos(th1_ + th2_) + l1*cos(th1_)))*(l1*thdot1_*cos(th1_) + 1/2*l2*cos(th1_ + th2_)*(thdot1_ + thdot2_)) + 2*cos(th4_)*(1/2*l2*sin(th1_ + th2_) + l1*sin(th1_))*(cos(th4_)*(1/2*l2*cos(th1_ + th2_) + l1*cos(th1_))*thdot4_^2 - 2*sin(th4_)*(l1*thdot1_*sin(th1_) + 1/2*l2*sin(th1_ + th2_)*(thdot1_ + thdot2_))*thdot4_ + cos(th4_)*(1/2*l2*cos(th1_ + th2_)*(thdot1_ + thdot2_)^2 + l1*thdot1_^2*cos(th1_))) + 2*thdot4_*cos(th4_)*(sin(th4_)*(l1*thdot1_*sin(th1_) + 1/2*l2*sin(th1_ + th2_)*(thdot1_ + thdot2_)) - thdot4_*cos(th4_)*(1/2*l2*cos(th1_ + th2_) + l1*cos(th1_)))*(1/2*l2*sin(th1_ + th2_) + l1*sin(th1_)) - 2*thdot4_*sin(th4_)*(cos(th4_)*(l1*thdot1_*sin(th1_) + 1/2*l2*sin(th1_ + th2_)*(thdot1_ + thdot2_)) + thdot4_*sin(th4_)*(1/2*l2*cos(th1_ + th2_) + l1*cos(th1_)))*(1/2*l2*sin(th1_ + th2_) + l1*sin(th1_))) + c1*thdot1_ - 1/2*m3*(2*(sin(th4_)*(l1*thdot1_*cos(th1_) + 1/2*l3*cos(th1_ + th2_ + th3_)*(thdot1_ + thdot2_ + thdot3_) + l2*cos(th1_ + th2_)*(thdot1_ + thdot2_)) + thdot4_*cos(th4_)*(l2*sin(th1_ + th2_) + l1*sin(th1_) + 1/2*l3*sin(th1_ + th2_ + th3_)))*(sin(th4_)*(l1*thdot1_*sin(th1_) + 1/2*l3*sin(th1_ + th2_ + th3_)*(thdot1_ + thdot2_ + thdot3_) + l2*sin(th1_ + th2_)*(thdot1_ + thdot2_)) - thdot4_*cos(th4_)*(l2*cos(th1_ + th2_) + l1*cos(th1_) + 1/2*l3*cos(th1_ + th2_ + th3_))) - 2*(l1*thdot1_*sin(th1_) + 1/2*l3*sin(th1_ + th2_ + th3_)*(thdot1_ + thdot2_ + thdot3_) + l2*sin(th1_ + th2_)*(thdot1_ + thdot2_))*(l1*thdot1_*cos(th1_) + 1/2*l3*cos(th1_ + th2_ + th3_)*(thdot1_ + thdot2_ + thdot3_) + l2*cos(th1_ + th2_)*(thdot1_ + thdot2_)) + 2*(cos(th4_)*(l1*thdot1_*sin(th1_) + 1/2*l3*sin(th1_ + th2_ + th3_)*(thdot1_ + thdot2_ + thdot3_) + l2*sin(th1_ + th2_)*(thdot1_ + thdot2_)) + thdot4_*sin(th4_)*(l2*cos(th1_ + th2_) + l1*cos(th1_) + 1/2*l3*cos(th1_ + th2_ + th3_)))*(cos(th4_)*(l1*thdot1_*cos(th1_) + 1/2*l3*cos(th1_ + th2_ + th3_)*(thdot1_ + thdot2_ + thdot3_) + l2*cos(th1_ + th2_)*(thdot1_ + thdot2_)) - thdot4_*sin(th4_)*(l2*sin(th1_ + th2_) + l1*sin(th1_) + 1/2*l3*sin(th1_ + th2_ + th3_)))) - 1/2*m2*(2*(sin(th4_)*(l1*thdot1_*cos(th1_) + 1/2*l2*cos(th1_ + th2_)*(thdot1_ + thdot2_)) + thdot4_*cos(th4_)*(1/2*l2*sin(th1_ + th2_) + l1*sin(th1_)))*(sin(th4_)*(l1*thdot1_*sin(th1_) + 1/2*l2*sin(th1_ + th2_)*(thdot1_ + thdot2_)) - thdot4_*cos(th4_)*(1/2*l2*cos(th1_ + th2_) + l1*cos(th1_))) + 2*(cos(th4_)*(l1*thdot1_*sin(th1_) + 1/2*l2*sin(th1_ + th2_)*(thdot1_ + thdot2_)) + thdot4_*sin(th4_)*(1/2*l2*cos(th1_ + th2_) + l1*cos(th1_)))*(cos(th4_)*(l1*thdot1_*cos(th1_) + 1/2*l2*cos(th1_ + th2_)*(thdot1_ + thdot2_)) - thdot4_*sin(th4_)*(1/2*l2*sin(th1_ + th2_) + l1*sin(th1_))) - 2*(l1*thdot1_*cos(th1_) + 1/2*l2*cos(th1_ + th2_)*(thdot1_ + thdot2_))*(l1*thdot1_*sin(th1_) + 1/2*l2*sin(th1_ + th2_)*(thdot1_ + thdot2_))) + 1/2*m3*(2*cos(th4_)*(l2*sin(th1_ + th2_) + l1*sin(th1_) + 1/2*l3*sin(th1_ + th2_ + th3_))*(cos(th4_)*(l2*cos(th1_ + th2_) + l1*cos(th1_) + 1/2*l3*cos(th1_ + th2_ + th3_))*thdot4_^2 - 2*sin(th4_)*(l1*thdot1_*sin(th1_) + 1/2*l3*sin(th1_ + th2_ + th3_)*(thdot1_ + thdot2_ + thdot3_) + l2*sin(th1_ + th2_)*(thdot1_ + thdot2_))*thdot4_ + cos(th4_)*(1/2*l3*cos(th1_ + th2_ + th3_)*(thdot1_ + thdot2_ + thdot3_)^2 + l2*cos(th1_ + th2_)*(thdot1_ + thdot2_)^2 + l1*thdot1_^2*cos(th1_))) - 2*(1/2*l3*sin(th1_ + th2_ + th3_)*(thdot1_ + thdot2_ + thdot3_)^2 + l2*sin(th1_ + th2_)*(thdot1_ + thdot2_)^2 + l1*thdot1_^2*sin(th1_))*(l2*cos(th1_ + th2_) + l1*cos(th1_) + 1/2*l3*cos(th1_ + th2_ + th3_)) - 2*(l1*thdot1_*sin(th1_) + 1/2*l3*sin(th1_ + th2_ + th3_)*(thdot1_ + thdot2_ + thdot3_) + l2*sin(th1_ + th2_)*(thdot1_ + thdot2_))*(l1*thdot1_*cos(th1_) + 1/2*l3*cos(th1_ + th2_ + th3_)*(thdot1_ + thdot2_ + thdot3_) + l2*cos(th1_ + th2_)*(thdot1_ + thdot2_)) + 2*sin(th4_)*(l2*sin(th1_ + th2_) + l1*sin(th1_) + 1/2*l3*sin(th1_ + th2_ + th3_))*(sin(th4_)*(l2*cos(th1_ + th2_) + l1*cos(th1_) + 1/2*l3*cos(th1_ + th2_ + th3_))*thdot4_^2 + 2*cos(th4_)*(l1*thdot1_*sin(th1_) + 1/2*l3*sin(th1_ + th2_ + th3_)*(thdot1_ + thdot2_ + thdot3_) + l2*sin(th1_ + th2_)*(thdot1_ + thdot2_))*thdot4_ + sin(th4_)*(1/2*l3*cos(th1_ + th2_ + th3_)*(thdot1_ + thdot2_ + thdot3_)^2 + l2*cos(th1_ + th2_)*(thdot1_ + thdot2_)^2 + l1*thdot1_^2*cos(th1_))) + 2*cos(th4_)*(cos(th4_)*(l1*thdot1_*sin(th1_) + 1/2*l3*sin(th1_ + th2_ + th3_)*(thdot1_ + thdot2_ + thdot3_) + l2*sin(th1_ + th2_)*(thdot1_ + thdot2_)) + thdot4_*sin(th4_)*(l2*cos(th1_ + th2_) + l1*cos(th1_) + 1/2*l3*cos(th1_ + th2_ + th3_)))*(l1*thdot1_*cos(th1_) + 1/2*l3*cos(th1_ + th2_ + th3_)*(thdot1_ + thdot2_ + thdot3_) + l2*cos(th1_ + th2_)*(thdot1_ + thdot2_)) + 2*sin(th4_)*(sin(th4_)*(l1*thdot1_*sin(th1_) + 1/2*l3*sin(th1_ + th2_ + th3_)*(thdot1_ + thdot2_ + thdot3_) + l2*sin(th1_ + th2_)*(thdot1_ + thdot2_)) - thdot4_*cos(th4_)*(l2*cos(th1_ + th2_) + l1*cos(th1_) + 1/2*l3*cos(th1_ + th2_ + th3_)))*(l1*thdot1_*cos(th1_) + 1/2*l3*cos(th1_ + th2_ + th3_)*(thdot1_ + thdot2_ + thdot3_) + l2*cos(th1_ + th2_)*(thdot1_ + thdot2_)) + 2*thdot4_*cos(th4_)*(sin(th4_)*(l1*thdot1_*sin(th1_) + 1/2*l3*sin(th1_ + th2_ + th3_)*(thdot1_ + thdot2_ + thdot3_) + l2*sin(th1_ + th2_)*(thdot1_ + thdot2_)) - thdot4_*cos(th4_)*(l2*cos(th1_ + th2_) + l1*cos(th1_) + 1/2*l3*cos(th1_ + th2_ + th3_)))*(l2*sin(th1_ + th2_) + l1*sin(th1_) + 1/2*l3*sin(th1_ + th2_ + th3_)) - 2*thdot4_*sin(th4_)*(cos(th4_)*(l1*thdot1_*sin(th1_) + 1/2*l3*sin(th1_ + th2_ + th3_)*(thdot1_ + thdot2_ + thdot3_) + l2*sin(th1_ + th2_)*(thdot1_ + thdot2_)) + thdot4_*sin(th4_)*(l2*cos(th1_ + th2_) + l1*cos(th1_) + 1/2*l3*cos(th1_ + th2_ + th3_)))*(l2*sin(th1_ + th2_) + l1*sin(th1_) + 1/2*l3*sin(th1_ + th2_ + th3_))) + Ixx1*thdot4_^2*cos(th1_)*sin(th1_) - Izz1*thdot4_^2*cos(th1_)*sin(th1_) + Ixx3*thdot4_^2*cos(th1_ + th2_ + th3_)*sin(th1_ + th2_ + th3_) - Izz3*thdot4_^2*cos(th1_ + th2_ + th3_)*sin(th1_ + th2_ + th3_) + Ixx2*thdot4_^2*cos(th1_ + th2_)*sin(th1_ + th2_) - Izz2*thdot4_^2*cos(th1_ + th2_)*sin(th1_ + th2_);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      c2*thdot2_ - 1/2*m3*(2*(cos(th4_)*(l1*thdot1_*sin(th1_) + 1/2*l3*sin(th1_ + th2_ + th3_)*(thdot1_ + thdot2_ + thdot3_) + l2*sin(th1_ + th2_)*(thdot1_ + thdot2_)) + thdot4_*sin(th4_)*(l2*cos(th1_ + th2_) + l1*cos(th1_) + 1/2*l3*cos(th1_ + th2_ + th3_)))*(cos(th4_)*(1/2*l3*cos(th1_ + th2_ + th3_)*(thdot1_ + thdot2_ + thdot3_) + l2*cos(th1_ + th2_)*(thdot1_ + thdot2_)) - thdot4_*sin(th4_)*(l2*sin(th1_ + th2_) + 1/2*l3*sin(th1_ + th2_ + th3_))) + 2*(sin(th4_)*(l1*thdot1_*sin(th1_) + 1/2*l3*sin(th1_ + th2_ + th3_)*(thdot1_ + thdot2_ + thdot3_) + l2*sin(th1_ + th2_)*(thdot1_ + thdot2_)) - thdot4_*cos(th4_)*(l2*cos(th1_ + th2_) + l1*cos(th1_) + 1/2*l3*cos(th1_ + th2_ + th3_)))*(sin(th4_)*(1/2*l3*cos(th1_ + th2_ + th3_)*(thdot1_ + thdot2_ + thdot3_) + l2*cos(th1_ + th2_)*(thdot1_ + thdot2_)) + thdot4_*cos(th4_)*(l2*sin(th1_ + th2_) + 1/2*l3*sin(th1_ + th2_ + th3_))) - 2*(1/2*l3*sin(th1_ + th2_ + th3_)*(thdot1_ + thdot2_ + thdot3_) + l2*sin(th1_ + th2_)*(thdot1_ + thdot2_))*(l1*thdot1_*cos(th1_) + 1/2*l3*cos(th1_ + th2_ + th3_)*(thdot1_ + thdot2_ + thdot3_) + l2*cos(th1_ + th2_)*(thdot1_ + thdot2_))) - 1/2*m2*(2*(cos(th4_)*(l1*thdot1_*sin(th1_) + 1/2*l2*sin(th1_ + th2_)*(thdot1_ + thdot2_)) + thdot4_*sin(th4_)*(1/2*l2*cos(th1_ + th2_) + l1*cos(th1_)))*(1/2*l2*cos(th1_ + th2_)*cos(th4_)*(thdot1_ + thdot2_) - 1/2*l2*thdot4_*sin(th1_ + th2_)*sin(th4_)) + 2*(sin(th4_)*(l1*thdot1_*sin(th1_) + 1/2*l2*sin(th1_ + th2_)*(thdot1_ + thdot2_)) - thdot4_*cos(th4_)*(1/2*l2*cos(th1_ + th2_) + l1*cos(th1_)))*(1/2*l2*cos(th1_ + th2_)*sin(th4_)*(thdot1_ + thdot2_) + 1/2*l2*thdot4_*sin(th1_ + th2_)*cos(th4_)) - l2*sin(th1_ + th2_)*(l1*thdot1_*cos(th1_) + 1/2*l2*cos(th1_ + th2_)*(thdot1_ + thdot2_))*(thdot1_ + thdot2_)) + Ixx3*thdot4_^2*cos(th1_ + th2_ + th3_)*sin(th1_ + th2_ + th3_) - Izz3*thdot4_^2*cos(th1_ + th2_ + th3_)*sin(th1_ + th2_ + th3_) + Ixx2*thdot4_^2*cos(th1_ + th2_)*sin(th1_ + th2_) - Izz2*thdot4_^2*cos(th1_ + th2_)*sin(th1_ + th2_) - 1/2*l2*l3*m3*thdot3_^2*sin(th3_) - 1/2*l1*l3*m3*thdot1_*thdot2_*sin(th2_ + th3_) - 1/2*l1*l3*m3*thdot1_*thdot3_*sin(th2_ + th3_) - 1/2*l1*l2*m2*thdot1_*thdot2_*sin(th2_) - l1*l2*m3*thdot1_*thdot2_*sin(th2_) - l2*l3*m3*thdot1_*thdot3_*sin(th3_) - l2*l3*m3*thdot2_*thdot3_*sin(th3_);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   c3*thdot3_ + 1/2*m3*(2*(1/2*l3*thdot4_*sin(th1_ + th2_ + th3_)*sin(th4_) - 1/2*l3*cos(th1_ + th2_ + th3_)*cos(th4_)*(thdot1_ + thdot2_ + thdot3_))*(cos(th4_)*(l1*thdot1_*sin(th1_) + 1/2*l3*sin(th1_ + th2_ + th3_)*(thdot1_ + thdot2_ + thdot3_) + l2*sin(th1_ + th2_)*(thdot1_ + thdot2_)) + thdot4_*sin(th4_)*(l2*cos(th1_ + th2_) + l1*cos(th1_) + 1/2*l3*cos(th1_ + th2_ + th3_))) - 2*(1/2*l3*thdot4_*sin(th1_ + th2_ + th3_)*cos(th4_) + 1/2*l3*cos(th1_ + th2_ + th3_)*sin(th4_)*(thdot1_ + thdot2_ + thdot3_))*(sin(th4_)*(l1*thdot1_*sin(th1_) + 1/2*l3*sin(th1_ + th2_ + th3_)*(thdot1_ + thdot2_ + thdot3_) + l2*sin(th1_ + th2_)*(thdot1_ + thdot2_)) - thdot4_*cos(th4_)*(l2*cos(th1_ + th2_) + l1*cos(th1_) + 1/2*l3*cos(th1_ + th2_ + th3_))) + l3*sin(th1_ + th2_ + th3_)*(thdot1_ + thdot2_ + thdot3_)*(l1*thdot1_*cos(th1_) + 1/2*l3*cos(th1_ + th2_ + th3_)*(thdot1_ + thdot2_ + thdot3_) + l2*cos(th1_ + th2_)*(thdot1_ + thdot2_))) + Ixx3*thdot4_^2*cos(th1_ + th2_ + th3_)*sin(th1_ + th2_ + th3_) - Izz3*thdot4_^2*cos(th1_ + th2_ + th3_)*sin(th1_ + th2_ + th3_) - 1/2*l1*l3*m3*thdot1_*thdot2_*sin(th2_ + th3_) - 1/2*l1*l3*m3*thdot1_*thdot3_*sin(th2_ + th3_) - 1/2*l2*l3*m3*thdot1_*thdot3_*sin(th3_) - 1/2*l2*l3*m3*thdot2_*thdot3_*sin(th3_);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               1/2*m2*(2*cos(th4_)*(sin(th4_)*(l1*thdot1_*sin(th1_) + 1/2*l2*sin(th1_ + th2_)*(thdot1_ + thdot2_)) - thdot4_*cos(th4_)*(1/2*l2*cos(th1_ + th2_) + l1*cos(th1_)))*(l1*thdot1_*sin(th1_) + 1/2*l2*sin(th1_ + th2_)*(thdot1_ + thdot2_)) - 2*sin(th4_)*(cos(th4_)*(l1*thdot1_*sin(th1_) + 1/2*l2*sin(th1_ + th2_)*(thdot1_ + thdot2_)) + thdot4_*sin(th4_)*(1/2*l2*cos(th1_ + th2_) + l1*cos(th1_)))*(l1*thdot1_*sin(th1_) + 1/2*l2*sin(th1_ + th2_)*(thdot1_ + thdot2_)) - 2*cos(th4_)*(1/2*l2*cos(th1_ + th2_) + l1*cos(th1_))*(sin(th4_)*(1/2*l2*cos(th1_ + th2_) + l1*cos(th1_))*thdot4_^2 + 2*cos(th4_)*(l1*thdot1_*sin(th1_) + 1/2*l2*sin(th1_ + th2_)*(thdot1_ + thdot2_))*thdot4_ + sin(th4_)*(1/2*l2*cos(th1_ + th2_)*(thdot1_ + thdot2_)^2 + l1*thdot1_^2*cos(th1_))) + 2*sin(th4_)*(1/2*l2*cos(th1_ + th2_) + l1*cos(th1_))*(cos(th4_)*(1/2*l2*cos(th1_ + th2_) + l1*cos(th1_))*thdot4_^2 - 2*sin(th4_)*(l1*thdot1_*sin(th1_) + 1/2*l2*sin(th1_ + th2_)*(thdot1_ + thdot2_))*thdot4_ + cos(th4_)*(1/2*l2*cos(th1_ + th2_)*(thdot1_ + thdot2_)^2 + l1*thdot1_^2*cos(th1_))) + 2*thdot4_*cos(th4_)*(cos(th4_)*(l1*thdot1_*sin(th1_) + 1/2*l2*sin(th1_ + th2_)*(thdot1_ + thdot2_)) + thdot4_*sin(th4_)*(1/2*l2*cos(th1_ + th2_) + l1*cos(th1_)))*(1/2*l2*cos(th1_ + th2_) + l1*cos(th1_)) + 2*thdot4_*sin(th4_)*(sin(th4_)*(l1*thdot1_*sin(th1_) + 1/2*l2*sin(th1_ + th2_)*(thdot1_ + thdot2_)) - thdot4_*cos(th4_)*(1/2*l2*cos(th1_ + th2_) + l1*cos(th1_)))*(1/2*l2*cos(th1_ + th2_) + l1*cos(th1_))) + 1/2*m3*(2*cos(th4_)*(sin(th4_)*(l1*thdot1_*sin(th1_) + 1/2*l3*sin(th1_ + th2_ + th3_)*(thdot1_ + thdot2_ + thdot3_) + l2*sin(th1_ + th2_)*(thdot1_ + thdot2_)) - thdot4_*cos(th4_)*(l2*cos(th1_ + th2_) + l1*cos(th1_) + 1/2*l3*cos(th1_ + th2_ + th3_)))*(l1*thdot1_*sin(th1_) + 1/2*l3*sin(th1_ + th2_ + th3_)*(thdot1_ + thdot2_ + thdot3_) + l2*sin(th1_ + th2_)*(thdot1_ + thdot2_)) - 2*sin(th4_)*(cos(th4_)*(l1*thdot1_*sin(th1_) + 1/2*l3*sin(th1_ + th2_ + th3_)*(thdot1_ + thdot2_ + thdot3_) + l2*sin(th1_ + th2_)*(thdot1_ + thdot2_)) + thdot4_*sin(th4_)*(l2*cos(th1_ + th2_) + l1*cos(th1_) + 1/2*l3*cos(th1_ + th2_ + th3_)))*(l1*thdot1_*sin(th1_) + 1/2*l3*sin(th1_ + th2_ + th3_)*(thdot1_ + thdot2_ + thdot3_) + l2*sin(th1_ + th2_)*(thdot1_ + thdot2_)) - 2*cos(th4_)*(l2*cos(th1_ + th2_) + l1*cos(th1_) + 1/2*l3*cos(th1_ + th2_ + th3_))*(sin(th4_)*(l2*cos(th1_ + th2_) + l1*cos(th1_) + 1/2*l3*cos(th1_ + th2_ + th3_))*thdot4_^2 + 2*cos(th4_)*(l1*thdot1_*sin(th1_) + 1/2*l3*sin(th1_ + th2_ + th3_)*(thdot1_ + thdot2_ + thdot3_) + l2*sin(th1_ + th2_)*(thdot1_ + thdot2_))*thdot4_ + sin(th4_)*(1/2*l3*cos(th1_ + th2_ + th3_)*(thdot1_ + thdot2_ + thdot3_)^2 + l2*cos(th1_ + th2_)*(thdot1_ + thdot2_)^2 + l1*thdot1_^2*cos(th1_))) + 2*sin(th4_)*(l2*cos(th1_ + th2_) + l1*cos(th1_) + 1/2*l3*cos(th1_ + th2_ + th3_))*(cos(th4_)*(l2*cos(th1_ + th2_) + l1*cos(th1_) + 1/2*l3*cos(th1_ + th2_ + th3_))*thdot4_^2 - 2*sin(th4_)*(l1*thdot1_*sin(th1_) + 1/2*l3*sin(th1_ + th2_ + th3_)*(thdot1_ + thdot2_ + thdot3_) + l2*sin(th1_ + th2_)*(thdot1_ + thdot2_))*thdot4_ + cos(th4_)*(1/2*l3*cos(th1_ + th2_ + th3_)*(thdot1_ + thdot2_ + thdot3_)^2 + l2*cos(th1_ + th2_)*(thdot1_ + thdot2_)^2 + l1*thdot1_^2*cos(th1_))) + 2*thdot4_*cos(th4_)*(cos(th4_)*(l1*thdot1_*sin(th1_) + 1/2*l3*sin(th1_ + th2_ + th3_)*(thdot1_ + thdot2_ + thdot3_) + l2*sin(th1_ + th2_)*(thdot1_ + thdot2_)) + thdot4_*sin(th4_)*(l2*cos(th1_ + th2_) + l1*cos(th1_) + 1/2*l3*cos(th1_ + th2_ + th3_)))*(l2*cos(th1_ + th2_) + l1*cos(th1_) + 1/2*l3*cos(th1_ + th2_ + th3_)) + 2*thdot4_*sin(th4_)*(sin(th4_)*(l1*thdot1_*sin(th1_) + 1/2*l3*sin(th1_ + th2_ + th3_)*(thdot1_ + thdot2_ + thdot3_) + l2*sin(th1_ + th2_)*(thdot1_ + thdot2_)) - thdot4_*cos(th4_)*(l2*cos(th1_ + th2_) + l1*cos(th1_) + 1/2*l3*cos(th1_ + th2_ + th3_)))*(l2*cos(th1_ + th2_) + l1*cos(th1_) + 1/2*l3*cos(th1_ + th2_ + th3_))) + c4*thdot4_ - 2*Ixx3*thdot4_*cos(th1_ + th2_ + th3_)*sin(th1_ + th2_ + th3_)*(thdot1_ + thdot2_ + thdot3_) + 2*Izz3*thdot4_*cos(th1_ + th2_ + th3_)*sin(th1_ + th2_ + th3_)*(thdot1_ + thdot2_ + thdot3_) - 2*Ixx1*thdot1_*thdot4_*cos(th1_)*sin(th1_) + 2*Izz1*thdot1_*thdot4_*cos(th1_)*sin(th1_) - 2*Ixx2*thdot4_*cos(th1_ + th2_)*sin(th1_ + th2_)*(thdot1_ + thdot2_) + 2*Izz2*thdot4_*cos(th1_ + th2_)*sin(th1_ + th2_)*(thdot1_ + thdot2_) - 1/2*l1^2*m1*thdot1_*thdot4_*cos(th1_)*cos(th4_)^2*sin(th1_) - 1/2*l1^2*m1*thdot1_*thdot4_*cos(th1_)*sin(th1_)*sin(th4_)^2;
 
 ]
M =[
 
 (m3*(2*(l2*cos(th1_ + th2_) + l1*cos(th1_) + (l3*cos(th1_ + th2_ + th3_))/2)*(l1*thdotdot1_*cos(th1_) + (l3*cos(th1_ + th2_ + th3_)*(thdotdot1_ + thdotdot2_ + thdotdot3_))/2 + l2*cos(th1_ + th2_)*(thdotdot1_ + thdotdot2_)) + 2*cos(th4_)*(cos(th4_)*(l1*thdotdot1_*sin(th1_) + (l3*sin(th1_ + th2_ + th3_)*(thdotdot1_ + thdotdot2_ + thdotdot3_))/2 + l2*sin(th1_ + th2_)*(thdotdot1_ + thdotdot2_)) + thdotdot4_*sin(th4_)*(l2*cos(th1_ + th2_) + l1*cos(th1_) + (l3*cos(th1_ + th2_ + th3_))/2))*(l2*sin(th1_ + th2_) + l1*sin(th1_) + (l3*sin(th1_ + th2_ + th3_))/2) + 2*sin(th4_)*(sin(th4_)*(l1*thdotdot1_*sin(th1_) + (l3*sin(th1_ + th2_ + th3_)*(thdotdot1_ + thdotdot2_ + thdotdot3_))/2 + l2*sin(th1_ + th2_)*(thdotdot1_ + thdotdot2_)) - thdotdot4_*cos(th4_)*(l2*cos(th1_ + th2_) + l1*cos(th1_) + (l3*cos(th1_ + th2_ + th3_))/2))*(l2*sin(th1_ + th2_) + l1*sin(th1_) + (l3*sin(th1_ + th2_ + th3_))/2)))/2 + Iyy1*thdotdot1_ + Iyy2*thdotdot1_ + Iyy2*thdotdot2_ + (m2*(2*(l1*thdotdot1_*cos(th1_) + (l2*cos(th1_ + th2_)*(thdotdot1_ + thdotdot2_))/2)*((l2*cos(th1_ + th2_))/2 + l1*cos(th1_)) + 2*sin(th4_)*(sin(th4_)*(l1*thdotdot1_*sin(th1_) + (l2*sin(th1_ + th2_)*(thdotdot1_ + thdotdot2_))/2) - thdotdot4_*cos(th4_)*((l2*cos(th1_ + th2_))/2 + l1*cos(th1_)))*((l2*sin(th1_ + th2_))/2 + l1*sin(th1_)) + 2*cos(th4_)*(cos(th4_)*(l1*thdotdot1_*sin(th1_) + (l2*sin(th1_ + th2_)*(thdotdot1_ + thdotdot2_))/2) + thdotdot4_*sin(th4_)*((l2*cos(th1_ + th2_))/2 + l1*cos(th1_)))*((l2*sin(th1_ + th2_))/2 + l1*sin(th1_))))/2 + (Iyy3*(thdotdot1_ + thdotdot2_ + thdotdot3_))/2 + Iyy3*(thdotdot1_/2 + thdotdot2_/2 + thdotdot3_/2) + (l1^2*m1*thdotdot1_)/4;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           Iyy2*thdotdot1_ + Iyy2*thdotdot2_ + Iyy3*thdotdot1_ + Iyy3*thdotdot2_ + Iyy3*thdotdot3_ + (l2^2*m2*thdotdot1_)/4 + (l2^2*m2*thdotdot2_)/4 + l2^2*m3*thdotdot1_ + l2^2*m3*thdotdot2_ + (l3^2*m3*thdotdot1_)/4 + (l3^2*m3*thdotdot2_)/4 + (l3^2*m3*thdotdot3_)/4 + (l1*l3*m3*thdotdot1_*cos(th2_ + th3_))/2 + (l1*l2*m2*thdotdot1_*cos(th2_))/2 + l1*l2*m3*thdotdot1_*cos(th2_) + l2*l3*m3*thdotdot1_*cos(th3_) + l2*l3*m3*thdotdot2_*cos(th3_) + (l2*l3*m3*thdotdot3_*cos(th3_))/2;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           Iyy3*thdotdot1_ + Iyy3*thdotdot2_ + Iyy3*thdotdot3_ + (l3^2*m3*thdotdot1_)/4 + (l3^2*m3*thdotdot2_)/4 + (l3^2*m3*thdotdot3_)/4 + (l1*l3*m3*thdotdot1_*cos(th2_ + th3_))/2 + (l2*l3*m3*thdotdot1_*cos(th3_))/2 + (l2*l3*m3*thdotdot2_*cos(th3_))/2;
                                                                                                                                                                           I4*thdotdot4_ - (m3*(2*cos(th4_)*(sin(th4_)*(l1*thdotdot1_*sin(th1_) + (l3*sin(th1_ + th2_ + th3_)*(thdotdot1_ + thdotdot2_ + thdotdot3_))/2 + l2*sin(th1_ + th2_)*(thdotdot1_ + thdotdot2_)) - thdotdot4_*cos(th4_)*(l2*cos(th1_ + th2_) + l1*cos(th1_) + (l3*cos(th1_ + th2_ + th3_))/2))*(l2*cos(th1_ + th2_) + l1*cos(th1_) + (l3*cos(th1_ + th2_ + th3_))/2) - 2*sin(th4_)*(cos(th4_)*(l1*thdotdot1_*sin(th1_) + (l3*sin(th1_ + th2_ + th3_)*(thdotdot1_ + thdotdot2_ + thdotdot3_))/2 + l2*sin(th1_ + th2_)*(thdotdot1_ + thdotdot2_)) + thdotdot4_*sin(th4_)*(l2*cos(th1_ + th2_) + l1*cos(th1_) + (l3*cos(th1_ + th2_ + th3_))/2))*(l2*cos(th1_ + th2_) + l1*cos(th1_) + (l3*cos(th1_ + th2_ + th3_))/2)))/2 - (m2*(2*cos(th4_)*(sin(th4_)*(l1*thdotdot1_*sin(th1_) + (l2*sin(th1_ + th2_)*(thdotdot1_ + thdotdot2_))/2) - thdotdot4_*cos(th4_)*((l2*cos(th1_ + th2_))/2 + l1*cos(th1_)))*((l2*cos(th1_ + th2_))/2 + l1*cos(th1_)) - 2*sin(th4_)*(cos(th4_)*(l1*thdotdot1_*sin(th1_) + (l2*sin(th1_ + th2_)*(thdotdot1_ + thdotdot2_))/2) + thdotdot4_*sin(th4_)*((l2*cos(th1_ + th2_))/2 + l1*cos(th1_)))*((l2*cos(th1_ + th2_))/2 + l1*cos(th1_))))/2 + Ixx2*thdotdot4_*cos(th1_ + th2_)^2 + Ixx1*thdotdot4_*cos(th1_)^2 - Izz2*thdotdot4_*(cos(th1_ + th2_)^2 - 1) + Ixx3*thdotdot4_*cos(th1_ + th2_ + th3_)^2 - Izz1*thdotdot4_*(cos(th1_)^2 - 1) - Izz3*thdotdot4_*(cos(th1_ + th2_ + th3_)^2 - 1) + (l1^2*m1*thdotdot4_*cos(th1_)^2*cos(th4_)^2)/4 + (l1^2*m1*thdotdot4_*cos(th1_)^2*sin(th4_)^2)/4;
 
 ];
Mmat =[
 
[ Iyy1 + Iyy2 + 1.0*Iyy3 + (m3*(2*(1.0*l2*sin(th1_ + th2_) + l1*sin(th1_) + 0.5*l3*sin(th1_ + th2_ + th3_))*(l2*sin(th1_ + th2_) + l1*sin(th1_) + (l3*sin(th1_ + th2_ + th3_))/2)*cos(th4_)^2 + 2*(1.0*l2*sin(th1_ + th2_) + l1*sin(th1_) + 0.5*l3*sin(th1_ + th2_ + th3_))*(l2*sin(th1_ + th2_) + l1*sin(th1_) + (l3*sin(th1_ + th2_ + th3_))/2)*sin(th4_)^2 + 2*(l2*cos(th1_ + th2_) + l1*cos(th1_) + (l3*cos(th1_ + th2_ + th3_))/2)*(1.0*l2*cos(th1_ + th2_) + l1*cos(th1_) + 0.5*l3*cos(th1_ + th2_ + th3_))))/2 + (l1^2*m1)/4 + (m2*(2*((l2*sin(th1_ + th2_))/2 + l1*sin(th1_))*(0.5*l2*sin(th1_ + th2_) + l1*sin(th1_))*cos(th4_)^2 + 2*((l2*sin(th1_ + th2_))/2 + l1*sin(th1_))*(0.5*l2*sin(th1_ + th2_) + l1*sin(th1_))*sin(th4_)^2 + 2*((l2*cos(th1_ + th2_))/2 + l1*cos(th1_))*(0.5*l2*cos(th1_ + th2_) + l1*cos(th1_))))/2, Iyy2 + 1.0*Iyy3 + (m3*(2*(1.0*l2*sin(th1_ + th2_) + 0.5*l3*sin(th1_ + th2_ + th3_))*(l2*sin(th1_ + th2_) + l1*sin(th1_) + (l3*sin(th1_ + th2_ + th3_))/2)*cos(th4_)^2 + 2*(1.0*l2*sin(th1_ + th2_) + 0.5*l3*sin(th1_ + th2_ + th3_))*(l2*sin(th1_ + th2_) + l1*sin(th1_) + (l3*sin(th1_ + th2_ + th3_))/2)*sin(th4_)^2 + 2*(1.0*l2*cos(th1_ + th2_) + 0.5*l3*cos(th1_ + th2_ + th3_))*(l2*cos(th1_ + th2_) + l1*cos(th1_) + (l3*cos(th1_ + th2_ + th3_))/2)))/2 + (m2*(1.0*l2*sin(th1_ + th2_)*((l2*sin(th1_ + th2_))/2 + l1*sin(th1_))*cos(th4_)^2 + 1.0*l2*sin(th1_ + th2_)*((l2*sin(th1_ + th2_))/2 + l1*sin(th1_))*sin(th4_)^2 + 1.0*l2*cos(th1_ + th2_)*((l2*cos(th1_ + th2_))/2 + l1*cos(th1_))))/2, 1.0*Iyy3 + (m3*(1.0*l3*sin(th1_ + th2_ + th3_)*(l2*sin(th1_ + th2_) + l1*sin(th1_) + (l3*sin(th1_ + th2_ + th3_))/2)*cos(th4_)^2 + 1.0*l3*sin(th1_ + th2_ + th3_)*(l2*sin(th1_ + th2_) + l1*sin(th1_) + (l3*sin(th1_ + th2_ + th3_))/2)*sin(th4_)^2 + 1.0*l3*cos(th1_ + th2_ + th3_)*(l2*cos(th1_ + th2_) + l1*cos(th1_) + (l3*cos(th1_ + th2_ + th3_))/2)))/2,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    0];
[                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 Iyy2 + Iyy3 + (l2^2*m2)/4 + l2^2*m3 + (l3^2*m3)/4 + (l1*l3*m3*cos(th2_ + th3_))/2 + (l1*l2*m2*cos(th2_))/2 + l1*l2*m3*cos(th2_) + l2*l3*m3*cos(th3_),                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    Iyy2 + Iyy3 + (l2^2*m2)/4 + l2^2*m3 + (l3^2*m3)/4 + l2*l3*m3*cos(th3_),                                                                                                                                                                                                                                                                                                                    (m3*l3^2)/4 + (l2*m3*cos(th3_)*l3)/2 + Iyy3,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    0];
[                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          Iyy3 + (l3^2*m3)/4 + (l1*l3*m3*cos(th2_ + th3_))/2 + (l2*l3*m3*cos(th3_))/2,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               (m3*l3^2)/4 + (l2*m3*cos(th3_)*l3)/2 + Iyy3,                                                                                                                                                                                                                                                                                                                                             (m3*l3^2)/4 + Iyy3,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    0];
[                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    0,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         0,                                                                                                                                                                                                                                                                                                                                                              0, I4 - Izz2*(cos(th1_ + th2_)^2 - 1) + (m2*(2*cos(th4_)^2*((l2*cos(th1_ + th2_))/2 + l1*cos(th1_))^2 + 2*sin(th4_)^2*((l2*cos(th1_ + th2_))/2 + l1*cos(th1_))^2))/2 + Ixx3*cos(th1_ + th2_ + th3_)^2 - Izz1*(cos(th1_)^2 - 1) - Izz3*(cos(th1_ + th2_ + th3_)^2 - 1) + Ixx2*cos(th1_ + th2_)^2 + Ixx1*cos(th1_)^2 + (m3*(2*cos(th4_)^2*(l2*cos(th1_ + th2_) + l1*cos(th1_) + (l3*cos(th1_ + th2_ + th3_))/2)^2 + 2*sin(th4_)^2*(l2*cos(th1_ + th2_) + l1*cos(th1_) + (l3*cos(th1_ + th2_ + th3_))/2)^2))/2 + (l1^2*m1*cos(th1_)^2*cos(th4_)^2)/4 + (l1^2*m1*cos(th1_)^2*sin(th4_)^2)/4];
]



%Ghat=simplify(Mmat^-1*G)
%Vhat=simplify(Mmat^-1*V)

%initial states;
states=[th1_ th2_ th3_ th4_ thdot1_ thdot2_ thdot3_ thdot4_]';
init=[pi/6 pi/12 pi/12 pi/3 0 0 0 0]';
tau=[tau1 tau2 tau3 tau4]';

thdesired=[pi/12 pi/3 pi/6 pi/2]';



states0=init;
    kinematics_4DOF_fun
%do in loop

cnt=0;
while (1==1)
    cnt=cnt+1;
%draw
%kinematics_4DOF_fun
if mod(cnt,10)==0
    kinematics_4DOF_fun
pause 
end

G0=subs(G,states,states0);
V0=subs(V,states,states0);

Mmat0=subs(Mmat,states,states0);

Ghat0=Mmat0^-1*G0;
Vhat0=Mmat0^-1*V0;

Ghat0mad=Ghat0;
Vhat0mad=0;

thdotdot1=-Vhat0-Ghat0+tauin+Ghat0mad+Vhat0mad  %check later M^-1&tauin
states0(5:8)=states0(5:8)+Ts*thdotdot1;
states0(1:4)=states0(1:4)+Ts*states0(5:8);


%P controller
dth=thdesired-states0(1:4);
Kp=[60;40;20;10];
Kv=[5 6 7 5]';
tauin=+Kp.*dth+Kv.*(-states0(5:8));
end
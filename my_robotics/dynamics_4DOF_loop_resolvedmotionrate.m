   th1_=states0(1);th2_=states0(2);th3_=states0(3);th4_=states0(4);
    thdot1_=states0(5);thdot2_=states0(6);thdot3_=states0(7);thdot4_=states0(8);
    cnt=cnt+1;
%draw
%kinematics_4DOF_fun
J0=[

[ -cos(th4_)*(l2*sin(th1_ + th2_) + l1*sin(th1_) + l3*sin(th1_ + th2_ + th3_)), -cos(th4_)*(l2*sin(th1_ + th2_) + l3*sin(th1_ + th2_ + th3_)), -l3*sin(th1_ + th2_ + th3_)*cos(th4_), -sin(th4_)*(l2*cos(th1_ + th2_) + l1*cos(th1_) + l3*cos(th1_ + th2_ + th3_))];
[ -sin(th4_)*(l2*sin(th1_ + th2_) + l1*sin(th1_) + l3*sin(th1_ + th2_ + th3_)), -sin(th4_)*(l2*sin(th1_ + th2_) + l3*sin(th1_ + th2_ + th3_)), -l3*sin(th1_ + th2_ + th3_)*sin(th4_),  cos(th4_)*(l2*cos(th1_ + th2_) + l1*cos(th1_) + l3*cos(th1_ + th2_ + th3_))];
[              l2*cos(th1_ + th2_) + l1*cos(th1_) + l3*cos(th1_ + th2_ + th3_),              l2*cos(th1_ + th2_) + l3*cos(th1_ + th2_ + th3_),            l3*cos(th1_ + th2_ + th3_),                                                                            0];
[                                                                            1,                                                             1,                                     1,                                                                            0];
];



G0 =[
 
 g*m4*(l2*cos(th1_ + th2_) + l1*cos(th1_) + 1/2*l3*cos(th1_ + th2_ + th3_)) + g*m3*(1/2*l2*cos(th1_ + th2_) + l1*cos(th1_)) + 1/2*g*l1*m2*cos(th1_);
                                                         g*m4*(l2*cos(th1_ + th2_) + 1/2*l3*cos(th1_ + th2_ + th3_)) + 1/2*g*l2*m3*cos(th1_ + th2_);
                                                                                                                1/2*g*l3*m4*cos(th1_ + th2_ + th3_);
                                                                                                                                                  0;
 
 ];

V0 =[
 
 1/2*m1*(2*(1/2*l1*thdot4_*sin(th1_)*sin(th4_) - 1/2*l1*thdot1_*cos(th1_)*cos(th4_))*(1/2*l1*thdot1_*cos(th4_)*sin(th1_) + 1/2*l1*thdot4_*cos(th1_)*sin(th4_)) - 2*(1/2*l1*thdot1_*sin(th1_)*sin(th4_) - 1/2*l1*thdot4_*cos(th1_)*cos(th4_))*(1/2*l1*thdot1_*cos(th1_)*sin(th4_) + 1/2*l1*thdot4_*cos(th4_)*sin(th1_)) + 1/2*l1^2*thdot1_^2*cos(th1_)*sin(th1_)) + 1/2*m2*(2*sin(th4_)*(1/2*l2*sin(th1_ + th2_) + l1*sin(th1_))*(sin(th4_)*(1/2*l2*cos(th1_ + th2_) + l1*cos(th1_))*thdot4_^2 + 2*cos(th4_)*(l1*thdot1_*sin(th1_) + 1/2*l2*sin(th1_ + th2_)*(thdot1_ + thdot2_))*thdot4_ + sin(th4_)*(1/2*l2*cos(th1_ + th2_)*(thdot1_ + thdot2_)^2 + l1*thdot1_^2*cos(th1_))) - 2*(1/2*l2*sin(th1_ + th2_)*(thdot1_ + thdot2_)^2 + l1*thdot1_^2*sin(th1_))*(1/2*l2*cos(th1_ + th2_) + l1*cos(th1_)) - 2*(l1*thdot1_*cos(th1_) + 1/2*l2*cos(th1_ + th2_)*(thdot1_ + thdot2_))*(l1*thdot1_*sin(th1_) + 1/2*l2*sin(th1_ + th2_)*(thdot1_ + thdot2_)) + 2*cos(th4_)*(cos(th4_)*(l1*thdot1_*sin(th1_) + 1/2*l2*sin(th1_ + th2_)*(thdot1_ + thdot2_)) + thdot4_*sin(th4_)*(1/2*l2*cos(th1_ + th2_) + l1*cos(th1_)))*(l1*thdot1_*cos(th1_) + 1/2*l2*cos(th1_ + th2_)*(thdot1_ + thdot2_)) + 2*sin(th4_)*(sin(th4_)*(l1*thdot1_*sin(th1_) + 1/2*l2*sin(th1_ + th2_)*(thdot1_ + thdot2_)) - thdot4_*cos(th4_)*(1/2*l2*cos(th1_ + th2_) + l1*cos(th1_)))*(l1*thdot1_*cos(th1_) + 1/2*l2*cos(th1_ + th2_)*(thdot1_ + thdot2_)) + 2*cos(th4_)*(1/2*l2*sin(th1_ + th2_) + l1*sin(th1_))*(cos(th4_)*(1/2*l2*cos(th1_ + th2_) + l1*cos(th1_))*thdot4_^2 - 2*sin(th4_)*(l1*thdot1_*sin(th1_) + 1/2*l2*sin(th1_ + th2_)*(thdot1_ + thdot2_))*thdot4_ + cos(th4_)*(1/2*l2*cos(th1_ + th2_)*(thdot1_ + thdot2_)^2 + l1*thdot1_^2*cos(th1_))) + 2*thdot4_*cos(th4_)*(sin(th4_)*(l1*thdot1_*sin(th1_) + 1/2*l2*sin(th1_ + th2_)*(thdot1_ + thdot2_)) - thdot4_*cos(th4_)*(1/2*l2*cos(th1_ + th2_) + l1*cos(th1_)))*(1/2*l2*sin(th1_ + th2_) + l1*sin(th1_)) - 2*thdot4_*sin(th4_)*(cos(th4_)*(l1*thdot1_*sin(th1_) + 1/2*l2*sin(th1_ + th2_)*(thdot1_ + thdot2_)) + thdot4_*sin(th4_)*(1/2*l2*cos(th1_ + th2_) + l1*cos(th1_)))*(1/2*l2*sin(th1_ + th2_) + l1*sin(th1_))) + c1*thdot1_ - 1/2*m3*(2*(sin(th4_)*(l1*thdot1_*cos(th1_) + 1/2*l3*cos(th1_ + th2_ + th3_)*(thdot1_ + thdot2_ + thdot3_) + l2*cos(th1_ + th2_)*(thdot1_ + thdot2_)) + thdot4_*cos(th4_)*(l2*sin(th1_ + th2_) + l1*sin(th1_) + 1/2*l3*sin(th1_ + th2_ + th3_)))*(sin(th4_)*(l1*thdot1_*sin(th1_) + 1/2*l3*sin(th1_ + th2_ + th3_)*(thdot1_ + thdot2_ + thdot3_) + l2*sin(th1_ + th2_)*(thdot1_ + thdot2_)) - thdot4_*cos(th4_)*(l2*cos(th1_ + th2_) + l1*cos(th1_) + 1/2*l3*cos(th1_ + th2_ + th3_))) - 2*(l1*thdot1_*sin(th1_) + 1/2*l3*sin(th1_ + th2_ + th3_)*(thdot1_ + thdot2_ + thdot3_) + l2*sin(th1_ + th2_)*(thdot1_ + thdot2_))*(l1*thdot1_*cos(th1_) + 1/2*l3*cos(th1_ + th2_ + th3_)*(thdot1_ + thdot2_ + thdot3_) + l2*cos(th1_ + th2_)*(thdot1_ + thdot2_)) + 2*(cos(th4_)*(l1*thdot1_*sin(th1_) + 1/2*l3*sin(th1_ + th2_ + th3_)*(thdot1_ + thdot2_ + thdot3_) + l2*sin(th1_ + th2_)*(thdot1_ + thdot2_)) + thdot4_*sin(th4_)*(l2*cos(th1_ + th2_) + l1*cos(th1_) + 1/2*l3*cos(th1_ + th2_ + th3_)))*(cos(th4_)*(l1*thdot1_*cos(th1_) + 1/2*l3*cos(th1_ + th2_ + th3_)*(thdot1_ + thdot2_ + thdot3_) + l2*cos(th1_ + th2_)*(thdot1_ + thdot2_)) - thdot4_*sin(th4_)*(l2*sin(th1_ + th2_) + l1*sin(th1_) + 1/2*l3*sin(th1_ + th2_ + th3_)))) - 1/2*m2*(2*(sin(th4_)*(l1*thdot1_*cos(th1_) + 1/2*l2*cos(th1_ + th2_)*(thdot1_ + thdot2_)) + thdot4_*cos(th4_)*(1/2*l2*sin(th1_ + th2_) + l1*sin(th1_)))*(sin(th4_)*(l1*thdot1_*sin(th1_) + 1/2*l2*sin(th1_ + th2_)*(thdot1_ + thdot2_)) - thdot4_*cos(th4_)*(1/2*l2*cos(th1_ + th2_) + l1*cos(th1_))) + 2*(cos(th4_)*(l1*thdot1_*sin(th1_) + 1/2*l2*sin(th1_ + th2_)*(thdot1_ + thdot2_)) + thdot4_*sin(th4_)*(1/2*l2*cos(th1_ + th2_) + l1*cos(th1_)))*(cos(th4_)*(l1*thdot1_*cos(th1_) + 1/2*l2*cos(th1_ + th2_)*(thdot1_ + thdot2_)) - thdot4_*sin(th4_)*(1/2*l2*sin(th1_ + th2_) + l1*sin(th1_))) - 2*(l1*thdot1_*cos(th1_) + 1/2*l2*cos(th1_ + th2_)*(thdot1_ + thdot2_))*(l1*thdot1_*sin(th1_) + 1/2*l2*sin(th1_ + th2_)*(thdot1_ + thdot2_))) + 1/2*m3*(2*cos(th4_)*(l2*sin(th1_ + th2_) + l1*sin(th1_) + 1/2*l3*sin(th1_ + th2_ + th3_))*(cos(th4_)*(l2*cos(th1_ + th2_) + l1*cos(th1_) + 1/2*l3*cos(th1_ + th2_ + th3_))*thdot4_^2 - 2*sin(th4_)*(l1*thdot1_*sin(th1_) + 1/2*l3*sin(th1_ + th2_ + th3_)*(thdot1_ + thdot2_ + thdot3_) + l2*sin(th1_ + th2_)*(thdot1_ + thdot2_))*thdot4_ + cos(th4_)*(1/2*l3*cos(th1_ + th2_ + th3_)*(thdot1_ + thdot2_ + thdot3_)^2 + l2*cos(th1_ + th2_)*(thdot1_ + thdot2_)^2 + l1*thdot1_^2*cos(th1_))) - 2*(1/2*l3*sin(th1_ + th2_ + th3_)*(thdot1_ + thdot2_ + thdot3_)^2 + l2*sin(th1_ + th2_)*(thdot1_ + thdot2_)^2 + l1*thdot1_^2*sin(th1_))*(l2*cos(th1_ + th2_) + l1*cos(th1_) + 1/2*l3*cos(th1_ + th2_ + th3_)) - 2*(l1*thdot1_*sin(th1_) + 1/2*l3*sin(th1_ + th2_ + th3_)*(thdot1_ + thdot2_ + thdot3_) + l2*sin(th1_ + th2_)*(thdot1_ + thdot2_))*(l1*thdot1_*cos(th1_) + 1/2*l3*cos(th1_ + th2_ + th3_)*(thdot1_ + thdot2_ + thdot3_) + l2*cos(th1_ + th2_)*(thdot1_ + thdot2_)) + 2*sin(th4_)*(l2*sin(th1_ + th2_) + l1*sin(th1_) + 1/2*l3*sin(th1_ + th2_ + th3_))*(sin(th4_)*(l2*cos(th1_ + th2_) + l1*cos(th1_) + 1/2*l3*cos(th1_ + th2_ + th3_))*thdot4_^2 + 2*cos(th4_)*(l1*thdot1_*sin(th1_) + 1/2*l3*sin(th1_ + th2_ + th3_)*(thdot1_ + thdot2_ + thdot3_) + l2*sin(th1_ + th2_)*(thdot1_ + thdot2_))*thdot4_ + sin(th4_)*(1/2*l3*cos(th1_ + th2_ + th3_)*(thdot1_ + thdot2_ + thdot3_)^2 + l2*cos(th1_ + th2_)*(thdot1_ + thdot2_)^2 + l1*thdot1_^2*cos(th1_))) + 2*cos(th4_)*(cos(th4_)*(l1*thdot1_*sin(th1_) + 1/2*l3*sin(th1_ + th2_ + th3_)*(thdot1_ + thdot2_ + thdot3_) + l2*sin(th1_ + th2_)*(thdot1_ + thdot2_)) + thdot4_*sin(th4_)*(l2*cos(th1_ + th2_) + l1*cos(th1_) + 1/2*l3*cos(th1_ + th2_ + th3_)))*(l1*thdot1_*cos(th1_) + 1/2*l3*cos(th1_ + th2_ + th3_)*(thdot1_ + thdot2_ + thdot3_) + l2*cos(th1_ + th2_)*(thdot1_ + thdot2_)) + 2*sin(th4_)*(sin(th4_)*(l1*thdot1_*sin(th1_) + 1/2*l3*sin(th1_ + th2_ + th3_)*(thdot1_ + thdot2_ + thdot3_) + l2*sin(th1_ + th2_)*(thdot1_ + thdot2_)) - thdot4_*cos(th4_)*(l2*cos(th1_ + th2_) + l1*cos(th1_) + 1/2*l3*cos(th1_ + th2_ + th3_)))*(l1*thdot1_*cos(th1_) + 1/2*l3*cos(th1_ + th2_ + th3_)*(thdot1_ + thdot2_ + thdot3_) + l2*cos(th1_ + th2_)*(thdot1_ + thdot2_)) + 2*thdot4_*cos(th4_)*(sin(th4_)*(l1*thdot1_*sin(th1_) + 1/2*l3*sin(th1_ + th2_ + th3_)*(thdot1_ + thdot2_ + thdot3_) + l2*sin(th1_ + th2_)*(thdot1_ + thdot2_)) - thdot4_*cos(th4_)*(l2*cos(th1_ + th2_) + l1*cos(th1_) + 1/2*l3*cos(th1_ + th2_ + th3_)))*(l2*sin(th1_ + th2_) + l1*sin(th1_) + 1/2*l3*sin(th1_ + th2_ + th3_)) - 2*thdot4_*sin(th4_)*(cos(th4_)*(l1*thdot1_*sin(th1_) + 1/2*l3*sin(th1_ + th2_ + th3_)*(thdot1_ + thdot2_ + thdot3_) + l2*sin(th1_ + th2_)*(thdot1_ + thdot2_)) + thdot4_*sin(th4_)*(l2*cos(th1_ + th2_) + l1*cos(th1_) + 1/2*l3*cos(th1_ + th2_ + th3_)))*(l2*sin(th1_ + th2_) + l1*sin(th1_) + 1/2*l3*sin(th1_ + th2_ + th3_))) + Ixx1*thdot4_^2*cos(th1_)*sin(th1_) - Izz1*thdot4_^2*cos(th1_)*sin(th1_) + Ixx3*thdot4_^2*cos(th1_ + th2_ + th3_)*sin(th1_ + th2_ + th3_) - Izz3*thdot4_^2*cos(th1_ + th2_ + th3_)*sin(th1_ + th2_ + th3_) + Ixx2*thdot4_^2*cos(th1_ + th2_)*sin(th1_ + th2_) - Izz2*thdot4_^2*cos(th1_ + th2_)*sin(th1_ + th2_);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      c2*thdot2_ - 1/2*m3*(2*(cos(th4_)*(l1*thdot1_*sin(th1_) + 1/2*l3*sin(th1_ + th2_ + th3_)*(thdot1_ + thdot2_ + thdot3_) + l2*sin(th1_ + th2_)*(thdot1_ + thdot2_)) + thdot4_*sin(th4_)*(l2*cos(th1_ + th2_) + l1*cos(th1_) + 1/2*l3*cos(th1_ + th2_ + th3_)))*(cos(th4_)*(1/2*l3*cos(th1_ + th2_ + th3_)*(thdot1_ + thdot2_ + thdot3_) + l2*cos(th1_ + th2_)*(thdot1_ + thdot2_)) - thdot4_*sin(th4_)*(l2*sin(th1_ + th2_) + 1/2*l3*sin(th1_ + th2_ + th3_))) + 2*(sin(th4_)*(l1*thdot1_*sin(th1_) + 1/2*l3*sin(th1_ + th2_ + th3_)*(thdot1_ + thdot2_ + thdot3_) + l2*sin(th1_ + th2_)*(thdot1_ + thdot2_)) - thdot4_*cos(th4_)*(l2*cos(th1_ + th2_) + l1*cos(th1_) + 1/2*l3*cos(th1_ + th2_ + th3_)))*(sin(th4_)*(1/2*l3*cos(th1_ + th2_ + th3_)*(thdot1_ + thdot2_ + thdot3_) + l2*cos(th1_ + th2_)*(thdot1_ + thdot2_)) + thdot4_*cos(th4_)*(l2*sin(th1_ + th2_) + 1/2*l3*sin(th1_ + th2_ + th3_))) - 2*(1/2*l3*sin(th1_ + th2_ + th3_)*(thdot1_ + thdot2_ + thdot3_) + l2*sin(th1_ + th2_)*(thdot1_ + thdot2_))*(l1*thdot1_*cos(th1_) + 1/2*l3*cos(th1_ + th2_ + th3_)*(thdot1_ + thdot2_ + thdot3_) + l2*cos(th1_ + th2_)*(thdot1_ + thdot2_))) - 1/2*m2*(2*(cos(th4_)*(l1*thdot1_*sin(th1_) + 1/2*l2*sin(th1_ + th2_)*(thdot1_ + thdot2_)) + thdot4_*sin(th4_)*(1/2*l2*cos(th1_ + th2_) + l1*cos(th1_)))*(1/2*l2*cos(th1_ + th2_)*cos(th4_)*(thdot1_ + thdot2_) - 1/2*l2*thdot4_*sin(th1_ + th2_)*sin(th4_)) + 2*(sin(th4_)*(l1*thdot1_*sin(th1_) + 1/2*l2*sin(th1_ + th2_)*(thdot1_ + thdot2_)) - thdot4_*cos(th4_)*(1/2*l2*cos(th1_ + th2_) + l1*cos(th1_)))*(1/2*l2*cos(th1_ + th2_)*sin(th4_)*(thdot1_ + thdot2_) + 1/2*l2*thdot4_*sin(th1_ + th2_)*cos(th4_)) - l2*sin(th1_ + th2_)*(l1*thdot1_*cos(th1_) + 1/2*l2*cos(th1_ + th2_)*(thdot1_ + thdot2_))*(thdot1_ + thdot2_)) + Ixx3*thdot4_^2*cos(th1_ + th2_ + th3_)*sin(th1_ + th2_ + th3_) - Izz3*thdot4_^2*cos(th1_ + th2_ + th3_)*sin(th1_ + th2_ + th3_) + Ixx2*thdot4_^2*cos(th1_ + th2_)*sin(th1_ + th2_) - Izz2*thdot4_^2*cos(th1_ + th2_)*sin(th1_ + th2_) - 1/2*l2*l3*m3*thdot3_^2*sin(th3_) - 1/2*l1*l3*m3*thdot1_*thdot2_*sin(th2_ + th3_) - 1/2*l1*l3*m3*thdot1_*thdot3_*sin(th2_ + th3_) - 1/2*l1*l2*m2*thdot1_*thdot2_*sin(th2_) - l1*l2*m3*thdot1_*thdot2_*sin(th2_) - l2*l3*m3*thdot1_*thdot3_*sin(th3_) - l2*l3*m3*thdot2_*thdot3_*sin(th3_);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   c3*thdot3_ + 1/2*m3*(2*(1/2*l3*thdot4_*sin(th1_ + th2_ + th3_)*sin(th4_) - 1/2*l3*cos(th1_ + th2_ + th3_)*cos(th4_)*(thdot1_ + thdot2_ + thdot3_))*(cos(th4_)*(l1*thdot1_*sin(th1_) + 1/2*l3*sin(th1_ + th2_ + th3_)*(thdot1_ + thdot2_ + thdot3_) + l2*sin(th1_ + th2_)*(thdot1_ + thdot2_)) + thdot4_*sin(th4_)*(l2*cos(th1_ + th2_) + l1*cos(th1_) + 1/2*l3*cos(th1_ + th2_ + th3_))) - 2*(1/2*l3*thdot4_*sin(th1_ + th2_ + th3_)*cos(th4_) + 1/2*l3*cos(th1_ + th2_ + th3_)*sin(th4_)*(thdot1_ + thdot2_ + thdot3_))*(sin(th4_)*(l1*thdot1_*sin(th1_) + 1/2*l3*sin(th1_ + th2_ + th3_)*(thdot1_ + thdot2_ + thdot3_) + l2*sin(th1_ + th2_)*(thdot1_ + thdot2_)) - thdot4_*cos(th4_)*(l2*cos(th1_ + th2_) + l1*cos(th1_) + 1/2*l3*cos(th1_ + th2_ + th3_))) + l3*sin(th1_ + th2_ + th3_)*(thdot1_ + thdot2_ + thdot3_)*(l1*thdot1_*cos(th1_) + 1/2*l3*cos(th1_ + th2_ + th3_)*(thdot1_ + thdot2_ + thdot3_) + l2*cos(th1_ + th2_)*(thdot1_ + thdot2_))) + Ixx3*thdot4_^2*cos(th1_ + th2_ + th3_)*sin(th1_ + th2_ + th3_) - Izz3*thdot4_^2*cos(th1_ + th2_ + th3_)*sin(th1_ + th2_ + th3_) - 1/2*l1*l3*m3*thdot1_*thdot2_*sin(th2_ + th3_) - 1/2*l1*l3*m3*thdot1_*thdot3_*sin(th2_ + th3_) - 1/2*l2*l3*m3*thdot1_*thdot3_*sin(th3_) - 1/2*l2*l3*m3*thdot2_*thdot3_*sin(th3_);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               1/2*m2*(2*cos(th4_)*(sin(th4_)*(l1*thdot1_*sin(th1_) + 1/2*l2*sin(th1_ + th2_)*(thdot1_ + thdot2_)) - thdot4_*cos(th4_)*(1/2*l2*cos(th1_ + th2_) + l1*cos(th1_)))*(l1*thdot1_*sin(th1_) + 1/2*l2*sin(th1_ + th2_)*(thdot1_ + thdot2_)) - 2*sin(th4_)*(cos(th4_)*(l1*thdot1_*sin(th1_) + 1/2*l2*sin(th1_ + th2_)*(thdot1_ + thdot2_)) + thdot4_*sin(th4_)*(1/2*l2*cos(th1_ + th2_) + l1*cos(th1_)))*(l1*thdot1_*sin(th1_) + 1/2*l2*sin(th1_ + th2_)*(thdot1_ + thdot2_)) - 2*cos(th4_)*(1/2*l2*cos(th1_ + th2_) + l1*cos(th1_))*(sin(th4_)*(1/2*l2*cos(th1_ + th2_) + l1*cos(th1_))*thdot4_^2 + 2*cos(th4_)*(l1*thdot1_*sin(th1_) + 1/2*l2*sin(th1_ + th2_)*(thdot1_ + thdot2_))*thdot4_ + sin(th4_)*(1/2*l2*cos(th1_ + th2_)*(thdot1_ + thdot2_)^2 + l1*thdot1_^2*cos(th1_))) + 2*sin(th4_)*(1/2*l2*cos(th1_ + th2_) + l1*cos(th1_))*(cos(th4_)*(1/2*l2*cos(th1_ + th2_) + l1*cos(th1_))*thdot4_^2 - 2*sin(th4_)*(l1*thdot1_*sin(th1_) + 1/2*l2*sin(th1_ + th2_)*(thdot1_ + thdot2_))*thdot4_ + cos(th4_)*(1/2*l2*cos(th1_ + th2_)*(thdot1_ + thdot2_)^2 + l1*thdot1_^2*cos(th1_))) + 2*thdot4_*cos(th4_)*(cos(th4_)*(l1*thdot1_*sin(th1_) + 1/2*l2*sin(th1_ + th2_)*(thdot1_ + thdot2_)) + thdot4_*sin(th4_)*(1/2*l2*cos(th1_ + th2_) + l1*cos(th1_)))*(1/2*l2*cos(th1_ + th2_) + l1*cos(th1_)) + 2*thdot4_*sin(th4_)*(sin(th4_)*(l1*thdot1_*sin(th1_) + 1/2*l2*sin(th1_ + th2_)*(thdot1_ + thdot2_)) - thdot4_*cos(th4_)*(1/2*l2*cos(th1_ + th2_) + l1*cos(th1_)))*(1/2*l2*cos(th1_ + th2_) + l1*cos(th1_))) + 1/2*m3*(2*cos(th4_)*(sin(th4_)*(l1*thdot1_*sin(th1_) + 1/2*l3*sin(th1_ + th2_ + th3_)*(thdot1_ + thdot2_ + thdot3_) + l2*sin(th1_ + th2_)*(thdot1_ + thdot2_)) - thdot4_*cos(th4_)*(l2*cos(th1_ + th2_) + l1*cos(th1_) + 1/2*l3*cos(th1_ + th2_ + th3_)))*(l1*thdot1_*sin(th1_) + 1/2*l3*sin(th1_ + th2_ + th3_)*(thdot1_ + thdot2_ + thdot3_) + l2*sin(th1_ + th2_)*(thdot1_ + thdot2_)) - 2*sin(th4_)*(cos(th4_)*(l1*thdot1_*sin(th1_) + 1/2*l3*sin(th1_ + th2_ + th3_)*(thdot1_ + thdot2_ + thdot3_) + l2*sin(th1_ + th2_)*(thdot1_ + thdot2_)) + thdot4_*sin(th4_)*(l2*cos(th1_ + th2_) + l1*cos(th1_) + 1/2*l3*cos(th1_ + th2_ + th3_)))*(l1*thdot1_*sin(th1_) + 1/2*l3*sin(th1_ + th2_ + th3_)*(thdot1_ + thdot2_ + thdot3_) + l2*sin(th1_ + th2_)*(thdot1_ + thdot2_)) - 2*cos(th4_)*(l2*cos(th1_ + th2_) + l1*cos(th1_) + 1/2*l3*cos(th1_ + th2_ + th3_))*(sin(th4_)*(l2*cos(th1_ + th2_) + l1*cos(th1_) + 1/2*l3*cos(th1_ + th2_ + th3_))*thdot4_^2 + 2*cos(th4_)*(l1*thdot1_*sin(th1_) + 1/2*l3*sin(th1_ + th2_ + th3_)*(thdot1_ + thdot2_ + thdot3_) + l2*sin(th1_ + th2_)*(thdot1_ + thdot2_))*thdot4_ + sin(th4_)*(1/2*l3*cos(th1_ + th2_ + th3_)*(thdot1_ + thdot2_ + thdot3_)^2 + l2*cos(th1_ + th2_)*(thdot1_ + thdot2_)^2 + l1*thdot1_^2*cos(th1_))) + 2*sin(th4_)*(l2*cos(th1_ + th2_) + l1*cos(th1_) + 1/2*l3*cos(th1_ + th2_ + th3_))*(cos(th4_)*(l2*cos(th1_ + th2_) + l1*cos(th1_) + 1/2*l3*cos(th1_ + th2_ + th3_))*thdot4_^2 - 2*sin(th4_)*(l1*thdot1_*sin(th1_) + 1/2*l3*sin(th1_ + th2_ + th3_)*(thdot1_ + thdot2_ + thdot3_) + l2*sin(th1_ + th2_)*(thdot1_ + thdot2_))*thdot4_ + cos(th4_)*(1/2*l3*cos(th1_ + th2_ + th3_)*(thdot1_ + thdot2_ + thdot3_)^2 + l2*cos(th1_ + th2_)*(thdot1_ + thdot2_)^2 + l1*thdot1_^2*cos(th1_))) + 2*thdot4_*cos(th4_)*(cos(th4_)*(l1*thdot1_*sin(th1_) + 1/2*l3*sin(th1_ + th2_ + th3_)*(thdot1_ + thdot2_ + thdot3_) + l2*sin(th1_ + th2_)*(thdot1_ + thdot2_)) + thdot4_*sin(th4_)*(l2*cos(th1_ + th2_) + l1*cos(th1_) + 1/2*l3*cos(th1_ + th2_ + th3_)))*(l2*cos(th1_ + th2_) + l1*cos(th1_) + 1/2*l3*cos(th1_ + th2_ + th3_)) + 2*thdot4_*sin(th4_)*(sin(th4_)*(l1*thdot1_*sin(th1_) + 1/2*l3*sin(th1_ + th2_ + th3_)*(thdot1_ + thdot2_ + thdot3_) + l2*sin(th1_ + th2_)*(thdot1_ + thdot2_)) - thdot4_*cos(th4_)*(l2*cos(th1_ + th2_) + l1*cos(th1_) + 1/2*l3*cos(th1_ + th2_ + th3_)))*(l2*cos(th1_ + th2_) + l1*cos(th1_) + 1/2*l3*cos(th1_ + th2_ + th3_))) + c4*thdot4_ - 2*Ixx3*thdot4_*cos(th1_ + th2_ + th3_)*sin(th1_ + th2_ + th3_)*(thdot1_ + thdot2_ + thdot3_) + 2*Izz3*thdot4_*cos(th1_ + th2_ + th3_)*sin(th1_ + th2_ + th3_)*(thdot1_ + thdot2_ + thdot3_) - 2*Ixx1*thdot1_*thdot4_*cos(th1_)*sin(th1_) + 2*Izz1*thdot1_*thdot4_*cos(th1_)*sin(th1_) - 2*Ixx2*thdot4_*cos(th1_ + th2_)*sin(th1_ + th2_)*(thdot1_ + thdot2_) + 2*Izz2*thdot4_*cos(th1_ + th2_)*sin(th1_ + th2_)*(thdot1_ + thdot2_) - 1/2*l1^2*m1*thdot1_*thdot4_*cos(th1_)*cos(th4_)^2*sin(th1_) - 1/2*l1^2*m1*thdot1_*thdot4_*cos(th1_)*sin(th1_)*sin(th4_)^2;
 
 ];

Mmat0 =[
 
[ Iyy1 + Iyy2 + 1.0*Iyy3 + (m3*(2*(1.0*l2*sin(th1_ + th2_) + l1*sin(th1_) + 0.5*l3*sin(th1_ + th2_ + th3_))*(l2*sin(th1_ + th2_) + l1*sin(th1_) + (l3*sin(th1_ + th2_ + th3_))/2)*cos(th4_)^2 + 2*(1.0*l2*sin(th1_ + th2_) + l1*sin(th1_) + 0.5*l3*sin(th1_ + th2_ + th3_))*(l2*sin(th1_ + th2_) + l1*sin(th1_) + (l3*sin(th1_ + th2_ + th3_))/2)*sin(th4_)^2 + 2*(l2*cos(th1_ + th2_) + l1*cos(th1_) + (l3*cos(th1_ + th2_ + th3_))/2)*(1.0*l2*cos(th1_ + th2_) + l1*cos(th1_) + 0.5*l3*cos(th1_ + th2_ + th3_))))/2 + (l1^2*m1)/4 + (m2*(2*((l2*sin(th1_ + th2_))/2 + l1*sin(th1_))*(0.5*l2*sin(th1_ + th2_) + l1*sin(th1_))*cos(th4_)^2 + 2*((l2*sin(th1_ + th2_))/2 + l1*sin(th1_))*(0.5*l2*sin(th1_ + th2_) + l1*sin(th1_))*sin(th4_)^2 + 2*((l2*cos(th1_ + th2_))/2 + l1*cos(th1_))*(0.5*l2*cos(th1_ + th2_) + l1*cos(th1_))))/2, Iyy2 + 1.0*Iyy3 + (m3*(2*(1.0*l2*sin(th1_ + th2_) + 0.5*l3*sin(th1_ + th2_ + th3_))*(l2*sin(th1_ + th2_) + l1*sin(th1_) + (l3*sin(th1_ + th2_ + th3_))/2)*cos(th4_)^2 + 2*(1.0*l2*sin(th1_ + th2_) + 0.5*l3*sin(th1_ + th2_ + th3_))*(l2*sin(th1_ + th2_) + l1*sin(th1_) + (l3*sin(th1_ + th2_ + th3_))/2)*sin(th4_)^2 + 2*(1.0*l2*cos(th1_ + th2_) + 0.5*l3*cos(th1_ + th2_ + th3_))*(l2*cos(th1_ + th2_) + l1*cos(th1_) + (l3*cos(th1_ + th2_ + th3_))/2)))/2 + (m2*(1.0*l2*sin(th1_ + th2_)*((l2*sin(th1_ + th2_))/2 + l1*sin(th1_))*cos(th4_)^2 + 1.0*l2*sin(th1_ + th2_)*((l2*sin(th1_ + th2_))/2 + l1*sin(th1_))*sin(th4_)^2 + 1.0*l2*cos(th1_ + th2_)*((l2*cos(th1_ + th2_))/2 + l1*cos(th1_))))/2, 1.0*Iyy3 + (m3*(1.0*l3*sin(th1_ + th2_ + th3_)*(l2*sin(th1_ + th2_) + l1*sin(th1_) + (l3*sin(th1_ + th2_ + th3_))/2)*cos(th4_)^2 + 1.0*l3*sin(th1_ + th2_ + th3_)*(l2*sin(th1_ + th2_) + l1*sin(th1_) + (l3*sin(th1_ + th2_ + th3_))/2)*sin(th4_)^2 + 1.0*l3*cos(th1_ + th2_ + th3_)*(l2*cos(th1_ + th2_) + l1*cos(th1_) + (l3*cos(th1_ + th2_ + th3_))/2)))/2,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    0];
[                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 Iyy2 + Iyy3 + (l2^2*m2)/4 + l2^2*m3 + (l3^2*m3)/4 + (l1*l3*m3*cos(th2_ + th3_))/2 + (l1*l2*m2*cos(th2_))/2 + l1*l2*m3*cos(th2_) + l2*l3*m3*cos(th3_),                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    Iyy2 + Iyy3 + (l2^2*m2)/4 + l2^2*m3 + (l3^2*m3)/4 + l2*l3*m3*cos(th3_),                                                                                                                                                                                                                                                                                                                    (m3*l3^2)/4 + (l2*m3*cos(th3_)*l3)/2 + Iyy3,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    0];
[                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          Iyy3 + (l3^2*m3)/4 + (l1*l3*m3*cos(th2_ + th3_))/2 + (l2*l3*m3*cos(th3_))/2,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               (m3*l3^2)/4 + (l2*m3*cos(th3_)*l3)/2 + Iyy3,                                                                                                                                                                                                                                                                                                                                             (m3*l3^2)/4 + Iyy3,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    0];
[                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    0,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         0,                                                                                                                                                                                                                                                                                                                                                              0, I4 - Izz2*(cos(th1_ + th2_)^2 - 1) + (m2*(2*cos(th4_)^2*((l2*cos(th1_ + th2_))/2 + l1*cos(th1_))^2 + 2*sin(th4_)^2*((l2*cos(th1_ + th2_))/2 + l1*cos(th1_))^2))/2 + Ixx3*cos(th1_ + th2_ + th3_)^2 - Izz1*(cos(th1_)^2 - 1) - Izz3*(cos(th1_ + th2_ + th3_)^2 - 1) + Ixx2*cos(th1_ + th2_)^2 + Ixx1*cos(th1_)^2 + (m3*(2*cos(th4_)^2*(l2*cos(th1_ + th2_) + l1*cos(th1_) + (l3*cos(th1_ + th2_ + th3_))/2)^2 + 2*sin(th4_)^2*(l2*cos(th1_ + th2_) + l1*cos(th1_) + (l3*cos(th1_ + th2_ + th3_))/2)^2))/2 + (l1^2*m1*cos(th1_)^2*cos(th4_)^2)/4 + (l1^2*m1*cos(th1_)^2*sin(th4_)^2)/4];
];



Ghat0=Mmat0^-1*G0;
Vhat0=Mmat0^-1*V0;

Ghat0mad=Ghat0*1;
Vhat0mad=Vhat0*1;

thdotdot1=-Vhat0-Ghat0+tauin+Ghat0mad+Vhat0mad;  %check later M^-1&tauin
if get(handles.wall,'Value')==0
states0(5:8)=states0(5:8)+Ts*thdotdot1;
states0(1:4)=states0(1:4)+Ts*states0(5:8);
end

%forward kinematics
e=[cos(states0(4))*(l1*cos(states0(1))+l2*cos(states0(1)+states0(2))+l3*cos(states0(1)+states0(2)+states0(3)));
   sin(states0(4))*( l1*cos(states0(1))+l2*cos(states0(1)+states0(2))+l3*cos(states0(1)+states0(2)+states0(3)));
    l4+l1*sin(states0(1))+l2*sin(states0(1)+states0(2))+l3*sin(states0(1)+states0(2)+states0(3))
    states0(1)+states0(2)+states0(3)];



%PD controller
de=edesired-e;

dth=J0^-1*de;

statesint=statesint+dth*Ts

% Kp=[60;50;40;40]*6;
% Kv=5*[10 7 7 6]';
% Ki=10*[3 2 1 0]';

Control1
tauin=+Kp.*dth+Kv.*(-states0(5:8))+Ki.*statesint;
states0;